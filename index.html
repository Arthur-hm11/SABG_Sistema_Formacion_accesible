
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de PromociÃ³n de la FormaciÃ³n AcadÃ©mica - SABG</title>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        :root {
            --guinda: #6B2C40;
            --vino: #8B3A52;
            --beige: #D4C4A8;
            --gold: #E8DCC4;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1e293b;
            --gradient1: linear-gradient(135deg, #6B2C40 0%, #8B3A52 100%);
            --gradient2: linear-gradient(135deg, #8B3A52 0%, #A0475E 100%);
            --gradient3: linear-gradient(135deg, #6B2C40 0%, #D4C4A8 100%);
            --gradient4: linear-gradient(135deg, #D4C4A8 0%, #E8DCC4 100%);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #6B2C40 0%, #8B3A52 25%, #A0475E 50%, #D4C4A8 100%);
            background-attachment: fixed;
            min-height: 100vh;
        }

        /* Login Screen */
        #loginScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #6B2C40 0%, #8B3A52 25%, #A0475E 50%, #D4C4A8 100%);
            background-attachment: fixed;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            overflow: hidden;
        }

        #loginScreen.hidden {
            display: none;
        }
        
        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid var(--guinda);
            border-top: none;
            border-radius: 0 0 10px 10px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none;
        }

        .autocomplete-suggestions.show {
            display: block;
        }

        .suggestion-item {
            padding: 0.8rem 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 1px solid #e2e8f0;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-item:hover,
        .suggestion-item.active {
            background: var(--gradient1);
            color: white;
            transform: translateX(5px);
        }

        .suggestion-item:hover .suggestion-highlight,
        .suggestion-item.active .suggestion-highlight {
            color: var(--beige);
        }

        .suggestion-highlight {
            font-weight: bold;
            color: var(--guinda);
        }

        .no-suggestions {
            padding: 1rem;
            text-align: center;
            color: #64748b;
            font-style: italic;
        }

        /* Login Container */
        .login-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 30px;
            padding: 3rem;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.4),
                        0 0 0 1px rgba(255, 255, 255, 0.2) inset;
            max-width: 450px;
            width: 90%;
            animation: slideInUp 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            position: relative;
            z-index: 1;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(100px) scale(0.8);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Login Logo */
        .login-logo {
            width: 120px;
            height: 120px;
            margin: 0 auto 2rem;
            background: linear-gradient(135deg, #6B2C40, #8B3A52);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 20px 40px rgba(107, 44, 64, 0.3),
                        0 0 0 10px rgba(107, 44, 64, 0.1),
                        0 0 0 20px rgba(107, 44, 64, 0.05);
            position: relative;
        }

        @keyframes pulseLogo {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 20px 40px rgba(107, 44, 64, 0.3),
                            0 0 0 10px rgba(107, 44, 64, 0.1),
                            0 0 0 20px rgba(107, 44, 64, 0.05);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 25px 50px rgba(107, 44, 64, 0.4),
                            0 0 0 15px rgba(107, 44, 64, 0.15),
                            0 0 0 30px rgba(107, 44, 64, 0.08);
            }
        }

        .login-logo::before {
            content: 'ðŸŽ“';
            font-size: 4rem;
        }

        @keyframes rotateLogo {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-10deg); }
            75% { transform: rotate(10deg); }
        }

        /* Login Title */
        .login-title {
            text-align: center;
            margin-bottom: 1rem;
        }

        .login-title h2 {
            background: linear-gradient(135deg, #6B2C40, #8B3A52);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        @keyframes gradientText {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .login-title p {
            color: #64748b;
            font-size: 1rem;
            margin-bottom: 2rem;
        }

        /* Login Form */
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .form-group {
            position: relative;
        }

        .form-group label {
            display: block;
            color: var(--guinda);
            font-weight: bold;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .input-icon {
            position: absolute;
            left: 1rem;
            font-size: 1.3rem;
            color: var(--guinda);
            transition: all 0.3s ease;
        }

        @keyframes bounceIcon {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .login-input {
            width: 100%;
            padding: 1rem 1rem 1rem 3.5rem;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .login-input:focus {
            outline: none;
            border-color: var(--guinda);
            box-shadow: 0 10px 30px rgba(107, 44, 64, 0.15),
                        0 0 0 4px rgba(107, 44, 64, 0.1);
            transform: translateY(-2px);
        }

        .login-input:focus + .input-icon {
            color: var(--vino);
            transform: scale(1.2) translateY(-5px);
            animation: none;
        }

        /* Role Selection */
        .role-selection {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .role-card {
            padding: 1.5rem;
            border: 3px solid #e2e8f0;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            position: relative;
            overflow: hidden;
        }

        .role-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(107, 44, 64, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .role-card:hover::before {
            left: 100%;
        }

        .role-card:hover {
            border-color: var(--guinda);
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 15px 40px rgba(107, 44, 64, 0.2);
        }

        .role-card.selected {
            border-color: var(--guinda);
            background: linear-gradient(135deg, #6B2C40, #8B3A52);
            color: white;
            transform: scale(1.05);
            box-shadow: 0 15px 40px rgba(107, 44, 64, 0.3);
        }

        .role-card .role-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            display: block;
        }

        @keyframes rotateRole {
            0%, 100% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(360deg) scale(1.2); }
        }

        .role-card.selected .role-icon {
            animation: bounceSelected 0.5s ease;
        }

        @keyframes bounceSelected {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.3); }
        }

        .role-card .role-name {
            font-weight: bold;
            font-size: 1.1rem;
        }

        /* Login Button */
        .login-btn {
            background: linear-gradient(135deg, #6B2C40, #8B3A52);
            color: white;
            border: none;
            padding: 1.2rem;
            border-radius: 15px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            /*text-transform: uppercase;*/
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(107, 44, 64, 0.3);
        }

        .login-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease;
        }

        .login-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .login-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(107, 44, 64, 0.4);
        }

        .login-btn:active {
            transform: translateY(0);
        }

        .login-btn span {
            position: relative;
            z-index: 1;
        }

        /* Test Users Info */
        .test-users {
            margin-top: 2rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(37, 99, 235, 0.1));
            border-radius: 15px;
            border: 2px dashed #3b82f6;
        }

        @keyframes pulseInfo {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
            }
        }

        .test-users h4 {
            color: #1e40af;
            margin-bottom: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.95rem;
        }

        .test-users p {
            color: #1e3a8a;
            font-size: 0.85rem;
            margin: 0.3rem 0;
            font-weight: 600;
        }

        /* Loading Animation */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            text-align: center;
        }

        .loading-spinner {
            width: 80px;
            height: 80px;
            border: 8px solid rgba(212, 196, 168, 0.3);
            border-top-color: #D4C4A8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            animation: fadeInOut 1.5s ease-in-out infinite;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Particles */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .particle {
            position: absolute;
            background: radial-gradient(circle, #E8DCC4, #D4C4A8);
            border-radius: 50%;
            opacity: 0.3;
            box-shadow: 0 0 10px rgba(212, 196, 168, 0.6);
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-100px) rotate(180deg); }
        }

        /* Header */
        header {
            background: linear-gradient(135deg, #6B2C40 0%, #8B3A52 100%);
            padding: 0;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
            animation: slideDown 0.8s ease;
        }
        
        .header-top {
            background: rgba(255, 255, 255, 0.98);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 3px solid var(--guinda);
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 2rem;
        }
        
        .header-logo-escudo {
            height: 70px;
            width: auto;
            filter: brightness(0.3) contrast(1.8) saturate(0);
        }
        
        .header-logo-sabg {
            height: 60px;
            width: auto;
        }
        
        .header-divider {
            width: 2px;
            height: 70px;
            background: linear-gradient(to bottom, transparent, var(--guinda), transparent);
        }
        
        .header-text {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }
        
        .header-title-small {
            font-size: 0.9rem;
            color: #64748b;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        
        .header-title-main {
            font-size: 1.3rem;
            color: var(--guinda);
            font-weight: bold;
        }
        
        .header-bottom {
            padding: 1.5rem 2rem;
            text-align: center;
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        h1 {
            color: white;
            font-size: 2rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            font-weight: bold;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .subtitle {
            color: #E8DCC4;
            font-size: 1.1rem;
            font-weight: 500;
        }

        /* User Info */
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: rgba(107, 44, 64, 0.1);
            padding: 0.7rem 1.2rem;
            border-radius: 50px;
            border: 2px solid var(--guinda);
        }
        
        .user-info span {
            color: var(--guinda);
            font-weight: 600;
        }

        .user-info .user-role {
            background: var(--gradient1);
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-weight: bold;
            color: white;
            font-size: 0.85rem;
        }

        .logout-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 0.5rem 1.2rem;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .logout-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
        }

        /* Main Navigation */
        .main-nav {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 1rem;
            display: flex;
            justify-content: center;
            gap: 1rem;
            position: relative;
            z-index: 100;
            flex-wrap: wrap;
        }

        .nav-item {
            position: relative;
        }

        .main-nav-btn {
            background: var(--gradient1);
            color: white;
            border: none;
            padding: 1rem 2.5rem;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .main-nav-btn:before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .main-nav-btn:hover:before {
            width: 300px;
            height: 300px;
        }

        .main-nav-btn:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
        }

        .main-nav-btn.active {
            background: var(--gradient3);
            transform: scale(1.1);
        }

        .main-nav-btn .arrow {
            transition: transform 0.3s ease;
            font-size: 0.8rem;
        }

        .main-nav-btn.expanded .arrow {
            transform: rotate(180deg);
        }

        /* Dropdown Menu */
        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(10px);
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 1rem;
            min-width: 250px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
            margin-top: 0.5rem;
        }

        .dropdown-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }

        .dropdown-item {
            padding: 1rem 1.5rem;
            color: var(--guinda);
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            margin: 0.3rem 0;
            border: 2px solid transparent;
        }

        .dropdown-item:hover {
            background: var(--gradient1);
            color: white;
            transform: translateX(5px);
            border-color: var(--guinda);
        }

        .dropdown-item.admin-only {
            background: rgba(245, 158, 11, 0.1);
            border: 2px dashed var(--warning);
        }

        .dropdown-item.admin-only:hover {
            background: linear-gradient(135deg, #f59e0b, #f97316);
            border-style: solid;
        }

        .dropdown-item .icon {
            font-size: 1.5rem;
        }

        .dropdown-item .badge {
            background: var(--warning);
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 20px;
            font-size: 0.7rem;
            margin-left: auto;
        }
        
        /* ======= Neutralizar apariencia de opciones solo-admin (sin etiquetas visibles) ======= */
        .dropdown-item.admin-only {
            background: transparent !important;
            border: 1px solid transparent !important;
        }
        .dropdown-item.admin-only:hover {
            background: rgba(255,255,255,0.10) !important;
            border: 1px solid rgba(255,255,255,0.15) !important;
        }
        .dropdown-item .badge {
            display: none !important;
        }
/* Container */
        .container {
            max-width: 1600px;
            margin: 2rem auto;
            padding: 2rem;
            position: relative;
            z-index: 10;
        }

        /* Sections */
        .main-section {
            display: none;
        }

        .main-section.active {
            display: block;
            animation: fadeInUp 0.8s ease;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Card */
        .card {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        @keyframes cardFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .card:hover {
            transform: translateY(-15px);
            box-shadow: 0 30px 80px rgba(0,0,0,0.4);
        }

        .card h2 {
            background: linear-gradient(135deg, #6B2C40 0%, #D4C4A8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 3px solid;
            border-image: var(--gradient1) 1;
        }

        /* Welcome Section */
        .welcome-hero {
            text-align: center;
            padding: 4rem 2rem;
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            margin-bottom: 3rem;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .welcome-hero h2 {
            font-size: 3rem;
            background: var(--gradient1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1.5rem;
        }

        .welcome-hero p {
            font-size: 1.3rem;
            color: #64748b;
            margin-bottom: 2rem;
            line-height: 1.8;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 3rem;
        }

        .feature-card {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            border-top: 5px solid var(--guinda);
        }

        .feature-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }

        .feature-card .icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .feature-card h3 {
            color: var(--guinda);
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .feature-card p {
            color: #64748b;
            line-height: 1.6;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin: 3rem 0;
        }

        .stat-card {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: var(--gradient1);
        }

        .stat-card:hover {
            transform: translateY(-10px) scale(1.05);
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }

        .stat-number {
            font-size: 3rem;
            font-weight: bold;
            background: linear-gradient(135deg, #6B2C40 0%, #D4C4A8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: countUp 2s ease;
        }

        @keyframes countUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .stat-label {
            color: #64748b;
            font-size: 1.1rem;
            margin-top: 0.5rem;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .tab {
            padding: 1rem 2rem;
            background: rgba(107, 44, 64, 0.2);
            border: 2px solid var(--guinda);
            border-radius: 10px;
            cursor: pointer;
            color: var(--guinda);
            font-weight: bold;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab:hover {
            background: rgba(107, 44, 64, 0.3);
            transform: translateY(-3px);
        }

        .tab.active {
            background: var(--gradient1);
            color: white;
            transform: scale(1.05);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Admin Controls */
        .admin-panel {
            background: linear-gradient(135deg, #f59e0b, #f97316);
            color: white;
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(245, 158, 11, 0.4);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .admin-panel h3 {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .admin-controls {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        /* Form */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            color: var(--dark);
            font-weight: bold;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        label .required {
            color: var(--danger);
        }

        input, select, textarea {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--guinda);
            transform: scale(1.01);
            box-shadow: 0 5px 15px rgba(107, 44, 64, 0.3);
        }

        /* Buttons */
        .btn {
            background: var(--gradient1);
            color: white;
            border: none;
            padding: 1rem 2.5rem;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            margin: 0.5rem;
            display: inline-block;
            position: relative;
            overflow: hidden;
        }

        .btn:before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover:before {
            width: 400px;
            height: 400px;
        }

        .btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #f97316);
        }

        .btn-secondary {
            background: var(--gradient4);
            color: var(--dark);
        }

        /* Table */
        .table-container {
            overflow-x: auto;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin: 2rem 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 1200px;
        }

        thead {
            background: var(--gradient1);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            padding: 1rem;
            text-align: left;
            font-weight: bold;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.9rem;
        }

        tbody tr {
            transition: all 0.3s ease;
        }

        tbody tr:hover {
            background: linear-gradient(90deg, rgba(107, 44, 64, 0.08), rgba(212, 196, 168, 0.08));
            transform: scale(1.01);
        }

        .estado-rojo {
            color: #ef4444;
            font-weight: bold;
        }

        /* Celdas editables */
        .editable-cell {
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .editable-cell:hover {
            background: #fef3c7 !important;
            box-shadow: inset 0 0 0 2px var(--warning);
        }

        .editable-cell.editing {
            padding: 0.5rem;
            background: white !important;
        }

        .editable-cell input,
        .editable-cell select,
        .editable-cell textarea {
            width: 100%;
            padding: 0.5rem;
            border: 2px solid var(--guinda);
            border-radius: 5px;
            font-size: 0.9rem;
            font-family: inherit;
        }

        .editable-cell textarea {
            min-height: 60px;
            resize: vertical;
        }

        .edit-icon {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--warning);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .editable-cell:hover .edit-icon {
            opacity: 1;
        }

        .editable-disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        .editable-disabled:hover {
            background: transparent !important;
            box-shadow: none !important;
        }

        /* Month Grid */
        .month-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .month-card {
            background: var(--gradient1);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }

        .month-card:before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.3), transparent);
            transform: scale(0);
            transition: transform 0.6s ease;
        }

        .month-card:hover:before {
            transform: scale(1);
        }

        .month-card:hover {
            transform: translateY(-10px) rotate(2deg);
            box-shadow: 0 15px 35px rgba(0,0,0,0.4);
        }

        .month-card h3 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 1;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            z-index: 2000;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            animation: scaleIn 0.4s ease;
        }

        @keyframes scaleIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal-close {
            float: right;
            font-size: 2rem;
            cursor: pointer;
            color: var(--danger);
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            transform: rotate(90deg) scale(1.2);
        }

        /* Info Box */
        .info-box {
            background: var(--gradient1);
            color: white;
            padding: 1.5rem;
            border-radius: 15px;
            margin: 1.5rem 0;
            box-shadow: 0 10px 30px rgba(107, 44, 64, 0.4);
        }

        .info-box h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .info-box ul {
            list-style: none;
            padding-left: 0;
        }

        .info-box li {
            padding: 0.5rem 0;
            padding-left: 2rem;
            position: relative;
        }

        .info-box li:before {
            content: 'âœ“';
            position: absolute;
            left: 0;
            color: #4ade80;
            font-size: 1.3rem;
            font-weight: bold;
        }

        /* File Upload */
        .file-upload {
            border: 3px dashed #cbd5e1;
            border-radius: 15px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8fafc;
            margin: 1rem 0;
        }

        .file-upload:hover {
            border-color: var(--guinda);
            background: #faf8f3;
            transform: scale(1.02);
        }

        /* Search Box */
        .search-box {
            width: 100%;
            padding: 1rem;
            font-size: 1.1rem;
            border: 2px solid var(--guinda);
            border-radius: 10px;
            margin-bottom: 1.5rem;
        }

        /* FAB */
        .fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            background: var(--gradient2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            z-index: 1500;
        }

        .fab:hover {
            transform: scale(1.1) rotate(90deg);
        }

        /* Footer */
        footer {
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(10px);
            padding: 2rem;
            text-align: center;
            color: white;
            margin-top: 3rem;
        }

        footer img {
            height: 50px;
            margin-bottom: 1rem;
            filter: drop-shadow(0 5px 15px rgba(212, 196, 168, 0.6));
        }

        footer p {
            color: #E8DCC4;
            margin: 0.5rem 0;
        }

        /* Hidden class */
        .hidden {
            display: none !important;
        }

        /* Subsections */
        .subsection {
            display: none;
        }

        .subsection.active {
            display: block;
            animation: fadeInUp 0.8s ease;
        }

        /* Responsive */
        @media (max-width: 768px) {
            h1 { font-size: 1.5rem; }
            .subtitle { font-size: 0.9rem; }
            .main-nav-btn { padding: 0.8rem 1.5rem; font-size: 1rem; }
            .card { padding: 1.5rem; }
            .month-grid { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }
            th, td { padding: 0.5rem; font-size: 0.8rem; }
            .welcome-hero h2 { font-size: 2rem; }
            .welcome-hero p { font-size: 1.1rem; }
            
            .header-top {
                flex-direction: column;
                gap: 1.5rem;
                padding: 1rem;
            }
            
            .header-left {
                flex-direction: column;
                text-align: center;
                gap: 0.8rem;
            }
            
            .header-right {
                flex-direction: column;
                gap: 1rem;
            }
            
            .header-divider {
                width: 60%;
                height: 2px;
                background: linear-gradient(to right, transparent, var(--guinda), transparent);
            }
            
            .header-logo-escudo {
                height: 50px;
            }
            
            .header-logo-sabg {
                height: 45px;
            }
            
            .header-title-small {
                font-size: 0.75rem;
            }
            
            .header-title-main {
                font-size: 1rem;
            }
            
            .header-bottom {
                padding: 1rem;
            }
            
            .user-info {
                flex-wrap: wrap;
                justify-content: center;
            }
        }

        /* ===============================
           ESTILOS MODAL REGISTRO
           =============================== */
        #registroModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10001;
            animation: fadeIn 0.3s ease;
        }
        #restaurarPasswordModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10002;
            animation: fadeIn 0.3s ease;
        }
        
        #restaurarPasswordModal.hidden {
            display: none;
        }
        
        #restaurarPasswordModal .modal-content {
            background: white;
            padding: 2.5rem;
            border-radius: 20px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            animation: scaleIn 0.4s ease;
        }
        
        #restaurarPasswordModal h3 {
            color: var(--guinda);
            margin-bottom: 1.5rem;
            text-align: center;
            font-size: 1.8rem;
            font-weight: bold;
        }
        
        #restaurarPasswordModal input {
            width: 100%;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }
        
        #restaurarPasswordModal input:focus {
            outline: none;
            border-color: var(--guinda);
            box-shadow: 0 5px 15px rgba(107, 44, 64, 0.3);
            transform: scale(1.01);
        }
        
        #restaurarPasswordModal .modal-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        #restaurarPasswordModal .modal-actions button {
            flex: 1;
            padding: 1rem;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }
        
        #restaurarPasswordModal .modal-actions button:first-child {
            background: var(--gradient1);
            color: white;
        }
        
        #restaurarPasswordModal .modal-actions button:last-child {
            background: #e2e8f0;
            color: var(--dark);
        }
        
        #restaurarPasswordModal .modal-actions button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        #registroModal.hidden {
            display: none;
        }

        #registroModal .modal-content {
            background: white;
            padding: 2.5rem;
            border-radius: 20px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            animation: scaleIn 0.4s ease;
        }

        #registroModal h3 {
            color: var(--guinda);
            margin-bottom: 1.5rem;
            text-align: center;
            font-size: 1.8rem;
            font-weight: bold;
        }

       #registroModal input {
    width: 100%;
    padding: 1rem;
    margin-bottom: 1rem;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    font-size: 16px;
    transition: all 0.3s ease;
    box-sizing: border-box;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-color: white;
}

#registroModal input:focus {
    outline: none;
    border-color: var(--guinda);
    box-shadow: 0 5px 15px rgba(107, 44, 64, 0.3);
    transform: scale(1.01);
}

#registroModal input::placeholder {
    color: #94a3b8;
    opacity: 1;
}

        #registroModal .modal-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        #registroModal .modal-actions button {
            flex: 1;
            padding: 1rem;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            position: relative;
            overflow: hidden;
        }

        #registroModal .modal-actions button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        #registroModal .modal-actions button:hover::before {
            width: 300px;
            height: 300px;
        }

        #registroModal .modal-actions button:first-child {
            background: var(--gradient1);
            color: white;
        }

        #registroModal .modal-actions button:last-child {
            background: #e2e8f0;
            color: var(--dark);
        }

        #registroModal .modal-actions button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        #registroModal .modal-actions button:active {
            transform: translateY(0);
        }

        .register-btn {
            background: linear-gradient(135deg, #10b981, #059669) !important;
            margin-top: 1rem;
            width: 100%;
            color: white;
            border: none;
            padding: 1rem 2rem;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
        }

        .register-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(16, 185, 129, 0.4);
        }

        .register-btn:active {
            transform: translateY(0);
        }
        .header-logo-escudo{
  height: 56px;          /* ajusta: 40â€“72px tÃ­pico en headers */
  width: auto;           /* respeta proporciÃ³n */
  max-width: 100%;
  object-fit: contain;   /* evita recortes */
  display: block;        /* quita espacios raros inline */
}

    
        /* Vista solo lectura para no superadmin */
        body:not(.role-superadmin) .editable-cell{
            pointer-events: none !important;
            cursor: default !important;
        }



/* === Dependencia / InstituciÃ³n: Autocomplete (mostrar texto completo) === */
.dep-autocomplete{position:relative;width:100%;}
.autocomplete-menu{
  position:absolute;
  left:0; right:0;
  top:calc(100% + 8px);
  background:rgba(15,18,22,0.98);
  border:1px solid rgba(196,157,104,0.22);
  border-radius:14px;
  box-shadow:0 18px 50px rgba(0,0,0,0.35);
  max-height:340px;
  overflow:auto;
  padding:8px;
  z-index:9999;
  display:none;
}
.autocomplete-menu.open{display:block;}
.autocomplete-item{
  width:100%;
  text-align:left;
  background:transparent;
  border:0;
  color:#fff;
  padding:12px 14px;
  border-radius:10px;
  cursor:pointer;
  white-space:normal;      /* âœ… permite varias lÃ­neas */
  line-height:1.35;
  font-weight:600;
}
.autocomplete-item:hover,
.autocomplete-item.active{
  background:rgba(98,17,50,0.35);
  outline:none;
}
.autocomplete-item small{opacity:.85;font-weight:500;}

        /* âœ… EXCEPCIÃ“N: permitir ediciÃ³n SOLO en OBSERVACIONES para TODOS los roles */
        body:not(.role-superadmin) td.editable-cell[data-field="observaciones"]{
            pointer-events: auto !important;
            cursor: text !important;
            opacity: 1 !important;
        }
        body:not(.role-superadmin) td.editable-cell[data-field="observaciones"]:hover{
            background: #fef3c7 !important;
            box-shadow: inset 0 0 0 2px var(--warning);
        }

        /* ================== ESTILO CARGA EXCEL ================== */
        .excel-upload-box {
            display: flex;
            gap: 12px;
            align-items: center;
            margin: 16px 0;
            padding: 12px;
            border: 1px dashed #8b3a4a;
            border-radius: 8px;
            background: #fff6f8;
        }
        .excel-upload-box button {
            background: #8b3a4a;
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
        }
        .excel-upload-box button:hover {
            opacity: 0.9;
        }

        /* Barra de acciones (Exportar + Cargar Excel) en una sola lÃ­nea */
        .actions-bar{
            display:flex;
            align-items:center;
            gap:14px;
            flex-wrap:wrap;
        }
        /* Integrar el cargador sin caja punteada cuando estÃ¡ en la barra */
        .actions-bar .excel-upload-box{
            margin:0;
            padding:0;
            border:none;
            background:transparent;
        }
        /* ========================================================= */

</style>
</head>
<body>
<!-- LOGIN SCREEN -->
    <div id="loginScreen">
        <div class="login-shapes">
            <div class="shape"></div>
            <div class="shape"></div>
            <div class="shape"></div>
            <div class="shape"></div>
        </div>

        <div class="login-container">
            <div class="login-logo"></div>
            
            <div class="login-title">
                <h2>SISTEMA DE FORMACIÃ“N</h2>
                <p>SecretarÃ­a AnticorrupciÃ³n y Buen Gobierno</p>
            </div>

            <form class="login-form" onsubmit="event.preventDefault(); loginUsuario();">
                <div class="form-group">
                    <label for="usuario">Usuario</label>
                    <div class="input-wrapper">
                        <input 
                            type="text" 
                            id="usuario" 
                            class="login-input" 
                            placeholder="Ingrese su usuario"
                            autocomplete="username"
                            required
                        >
                        <span class="input-icon">ðŸ‘¤</span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="password">CONTRASEÃ‘A</label>
                    <div class="input-wrapper">
                        <input 
                            type="password" 
                            id="password" 
                            class="login-input" 
                            placeholder="Ingrese su contraseÃ±a"
                            autocomplete="current-password"
                            required
                        >
                        <span class="input-icon">ðŸ”’</span>
                    </div>
                </div>
                <button type="submit" class="login-btn">ðŸš€ Iniciar sesiÃ³n</button>
            <button type="button" class="register-btn" onclick="mostrarRegistro()">
                ðŸ“ Registrarse
            </button>
            <button type="button" class="btn-secondary" onclick="mostrarRestaurarPassword()" style="background: linear-gradient(135deg, #64748b, #475569) !important; margin-top: 0.5rem; width: 100%; color: white; border: none; padding: 1rem 2rem; font-size: 1rem; font-weight: bold; border-radius: 15px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 5px 15px rgba(71, 85, 105, 0.3);">
                ðŸ”‘ Â¿Olvidaste tu contraseÃ±a?
            </button>
            </form>
        </div>
    </div>
    <!-- LOADING OVERLAY -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">ðŸš€ Iniciando sesiÃ³n...</div>
        </div>
    </div>

    <div class="particles" id="particles"></div>

    <header>
        <div class="header-top">
            <div class="header-left">
                <div class="header-divider"></div>
                <div class="header-text">
                    <div class="header-title-small">Gobierno de MÃ©xico</div>
                    <div class="header-title-main">SecretarÃ­a AnticorrupciÃ³n y Buen Gobierno</div>
                </div>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <span id="userName">ðŸ‘¤ Usuario</span>
                    <span class="user-role" id="userRole">Enlace</span>
                    <button class="logout-btn" onclick="logout()">ðŸšª Salir</button>
                </div>
            </div>
        </div>
        <div class="header-bottom">
            <h1>Sistema de PromociÃ³n de la FormaciÃ³n AcadÃ©mica</h1>
            <p class="subtitle">DirecciÃ³n de CapacitaciÃ³n y EvaluaciÃ³n del DesempeÃ±o</p>
        </div>
    </header>

    <nav class="main-nav">
        <div class="nav-item">
            <button class="main-nav-btn active" onclick="showMainSection('inicio')">
                ðŸ  Inicio
            </button>
        </div>

        <div class="nav-item">
            <button class="main-nav-btn" onclick="toggleDropdown('dropdownTrimestral', this)">
                ðŸ“Š Reporte Trimestral FormaciÃ³n AcadÃ©mica
                <span class="arrow">â–¼</span>
            </button>
            <div id="dropdownTrimestral" class="dropdown-menu">
                <div class="dropdown-item" onclick="showSectionAndTab('trimestral', 'instructivo')" role="button" tabindex="0">
                    <span class="icon">ðŸ“–</span>
                    <span>Instructivo</span>
                </div>
                <div class="dropdown-item" onclick="showSectionAndTab('trimestral', 'formulario')" role="button" tabindex="0">
                    <span class="icon">ðŸ“</span>
                    <span>Formulario de Registro</span>
                </div>
<div class="dropdown-item" id="dropdownItemTabla" onclick="showSectionAndTab('trimestral', 'tabla')" role="button" tabindex="0">
                    <span class="icon">ðŸ“‹</span>
                    <span>Ver Tabla de Registros</span>
</div>
            </div>
        </div>

        <div class="nav-item">
            <button class="main-nav-btn" onclick="toggleDropdown('dropdownEvidencias', this)">
                ðŸ“„ Reporte de Evidencias Mensuales
                <span class="arrow">â–¼</span>
            </button>
            <div id="dropdownEvidencias" class="dropdown-menu">
                <div class="dropdown-item" onclick="showSectionAndTab('evidencias', 'registro')" role="button" tabindex="0">
                    <span class="icon">ðŸ“…</span>
                    <span>Registrar Evidencias</span>
                </div>
                <div class="dropdown-item admin-only" id="dropdownItemRevision" onclick="showSectionAndTab('evidencias', 'revision')" role="button" tabindex="0">
                    <span class="icon">ðŸ”</span>
                    <span>Panel RevisiÃ³n DCEVE</span>
</div>
            </div>
        </div>
    </nav>

    <div class="container">
        
        <!-- PÃGINA DE INICIO -->
        <div id="inicio" class="main-section active">
            <div class="welcome-hero">
                <h2>ðŸŽ“ Bienvenido al Sistema de PromociÃ³n de la FormaciÃ³n AcadÃ©mica</h2>
                <p>
                    Este sistema integral permite a las dependencias e instituciones de la AdministraciÃ³n PÃºblica Federal 
                    gestionar, registrar y dar seguimiento a los procesos de formaciÃ³n acadÃ©mica de las personas servidoras pÃºblicas.
                </p>
                <p style="font-size: 1.1rem; color: var(--guinda); font-weight: bold; margin-top: 1rem;">
                    Seleccione una opciÃ³n del menÃº superior para comenzar
                </p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number"><span id="statDependencias">156</span></div>
                    <div class="stat-label">Dependencias Registradas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number"><span id="statServidores">2,847</span></div>
                    <div class="stat-label">Servidores PÃºblicos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number"><span id="statCumplimiento">89%</span></div>
                    <div class="stat-label">Tasa de Cumplimiento</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number"><span id="statActivos">1,245</span></div>
                    <div class="stat-label">Registros Activos</div>
                </div>
            </div>

            <div class="features-grid">
                <div class="feature-card">
                    <div class="icon">ðŸ“Š</div>
                    <h3>Reporte Trimestral</h3>
                    <p>
                        Registre y dÃ© seguimiento al avance acadÃ©mico de las personas servidoras pÃºblicas de su dependencia. 
                        Incluye formulario completo con todos los campos requeridos.
                    </p>
                </div>
                <div class="feature-card">
                    <div class="icon">ðŸ“„</div>
                    <h3>Evidencias Mensuales</h3>
                    <p>
                        Cargue y gestione las evidencias documentales mes con mes. El sistema permite adjuntar archivos PDF 
                        que serÃ¡n almacenados automÃ¡ticamente en Google Drive.
                    </p>
                </div>
                <div class="feature-card">
                    <div class="icon">ðŸ”</div>
                    <h3>Panel de Control DCEVE</h3>
                    <p>
                        Los administradores pueden revisar, validar y gestionar todos los registros. Control completo sobre 
                        permisos de ediciÃ³n y exportaciÃ³n de datos.
                    </p>
                </div>
                <div class="feature-card">
                    <div class="icon">ðŸ“ˆ</div>
                    <h3>Seguimiento en Tiempo Real</h3>
                    <p>
                        Visualice el estado de avance de cada registro. Los usuariostados desactualizados se marcan automÃ¡ticamente 
                        para facilitar su identificaciÃ³n.
                    </p>
                </div>
                <div class="feature-card">
                    <div class="icon">ðŸ“¥</div>
                    <h3>ExportaciÃ³n de Datos</h3>
                    <p>
                        Descargue la informaciÃ³n en mÃºltiples formatos: Excel, CSV y SQL. Ideal para generar reportes 
                        y anÃ¡lisis personalizados.
                    </p>
                </div>
                <div class="feature-card">
                    <div class="icon">ðŸ”’</div>
                    <h3>Seguridad y Permisos</h3>
                    <p>
                        Sistema de roles que garantiza que cada usuario tenga acceso Ãºnicamente a las funciones correspondientes 
                        a su nivel de autorizaciÃ³n.
                    </p>
                </div>
            </div>

            <div class="card" style="margin-top: 3rem;">
                <h2>ðŸ“Œ Funcionalidades Principales</h2>
                <div class="info-box">
                    <ul>
                        <li>Registro completo de personas servidoras pÃºblicas interesadas en formaciÃ³n acadÃ©mica</li>
                        <li>Seguimiento trimestral del estado de avance educativo</li>
                        <li>Carga mensual de evidencias documentales en formato PDF</li>
                        <li>Panel de revisiÃ³n y validaciÃ³n para la DCEVE</li>
                        <li>Control de permisos por roles (Enlace, Super Admin)</li>
                        <li>ActualizaciÃ³n automÃ¡tica de estados y registros</li>
                        <li>ExportaciÃ³n de datos en mÃºltiples formatos</li>
                        <li>Notificaciones de estados desactualizados</li>
                        <li>IntegraciÃ³n con Google Drive para almacenamiento</li>
                        <li>BÃºsqueda y filtrado avanzado en tablas</li>
                    </ul>
                </div>
            </div>
        </div>
        <!-- SECCIÃ“N: REPORTE TRIMESTRAL -->
        <div id="trimestral" class="main-section">
            <div class="card">
                <h2>ðŸ“Š Reporte Trimestral de FormaciÃ³n AcadÃ©mica</h2>
                
                <!-- Panel Admin (solo visible para Super Admin) -->
                <div id="adminPanelTrimestral" class="admin-panel hidden">
                <h3>âš™ï¸ Panel de Control - </h3>
                <div class="admin-controls">
                    <button class="btn btn-success" onclick="desbloquearEdicion()">
                        ðŸ”“ Desbloquear EdiciÃ³n
                    </button>
                    <button class="btn btn-danger" onclick="bloquearEdicion()">
                        ðŸ”’ Bloquear EdiciÃ³n
                    </button>
                    <button class="btn btn-warning" onclick="descargarBackup()">
                        ðŸ’¾ Descargar Backup
                    </button>
                </div>
            </div>
                <div class="tabs">
                    <div class="tab active" onclick="showTrimestralTab('instructivo')" role="button" tabindex="0">
                        ðŸ“– Instructivo
                    </div>
                    <div class="tab" onclick="showTrimestralTab('formulario')" role="button" tabindex="0">
                        ðŸ“ Formulario de Registro
                    </div>
                    <div id="tabVerTabla" class="tab " onclick="showTrimestralTab('tabla')" role="button" tabindex="0">
                        ðŸ“‹ Ver Tabla de Registros
                    </div>
                </div>

                <!-- TAB: INSTRUCTIVO -->
                <div id="instructivo" class="tab-content active">
                    <div class="info-box">
                        <h3>ðŸ“– INSTRUCTIVO PARA EL LLENADO DEL FORMATO</h3>
                        <p style="margin-bottom: 1rem;"><strong>Nota:</strong> Se solicita de la manera mÃ¡s atenta respetar los formatos de cada celda a llenar. En caso de tener duda con el registro de los mismos, favor de contactar a la Subdirectora de FormaciÃ³n y CapacitaciÃ³n Institucional A, al correo correo[arroba]institucional[punto]gob[punto]mx</p>
                    </div>

                    <div class="card" style="background: white; padding: 2rem; margin: 2rem 0;">
                        <h3 style="color: var(--guinda); margin-bottom: 1.5rem;">ðŸ“‹ DEFINICIONES DE CAMPOS</h3>
                        
                        <div style="margin-bottom: 2rem; padding: 1.5rem; background: #f8fafc; border-left: 5px solid var(--guinda); border-radius: 10px;">
                            <h4 style="color: var(--guinda); margin-bottom: 0.5rem;">NÂ°</h4>
                            <p style="color: #64748b;">Corresponde al nÃºmero consecutivo de registro.</p>
                        </div>

                        <div style="margin-bottom: 2rem; padding: 1.5rem; background: #f8fafc; border-left: 5px solid var(--guinda); border-radius: 10px;">
                            <h4 style="color: var(--guinda); margin-bottom: 0.5rem;">TRIMESTRE</h4>
                            <p style="color: #ef4444; font-weight: bold; margin-bottom: 0.5rem;">*Nota: La celda para registro estÃ¡ vinculada, si no selecciona el trimestre, no se desplegarÃ¡ la lista para seleccionar el Estado de Avance de la persona servidora pÃºblica interesada.</p>
                            <p style="color: #64748b;">Corresponde al trimestre en que se registrÃ³ a la persona servidora pÃºblica interesada.</p>
                        </div>

                        <div style="margin-bottom: 2rem; padding: 1.5rem; background: #f8fafc; border-left: 5px solid var(--guinda); border-radius: 10px;">
                            <h4 style="color: var(--guinda); margin-bottom: 0.5rem;">ID RUSP</h4>
                            <p style="color: #64748b; margin-bottom: 0.5rem;">Corresponde al nÃºmero de identificaciÃ³n de cada persona servidora pÃºblica en el Registro de Servidores PÃºblicos. De no tener el dato, favor de acercarse con el Ã¡rea de Recursos Humanos para su obtenciÃ³n y registro.</p>
                            <p style="color: #ef4444; font-weight: bold;">*Nota: En caso de ser personal de HONORARIOS, favor de registrar: HONORARIOS.</p>
                        </div>
                    </div>

                    <div class="info-box">
                        <h3>âš ï¸ RECORDATORIOS IMPORTANTES</h3>
                        <ul>
                            <li>El Enlace de FormaciÃ³n AcadÃ©mica tendrÃ¡ que actualizar el estado de avance, de lo contrario no podrÃ¡ cerrar el apartado de Ver Tabla de Registro</li>
                            <li>Los usuariostados desactualizados se visualizarÃ¡n en color rojo en la tabla</li>
                            <li>La DCEVE tiene control para bloquear/desbloquear la ediciÃ³n de datos</li>
                            <li>Respete el orden de llenado en campos vinculados (cascada de opciones)</li>
                            <li>Verifique cuidadosamente los datos de contacto (correo y telÃ©fono)</li>
                        </ul>
                    </div>
                </div>

                <!-- TAB: FORMULARIO -->
                <div id="formulario" class="tab-content">
                    <h3 style="color: var(--guinda); margin-bottom: 1.5rem;">ðŸ‘¤ Datos del Enlace de FormaciÃ³n AcadÃ©mica</h3>
                    
                    <form id="trimestralForm" onsubmit="event.preventDefault(); guardarRegistroTrimestral();">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="enlace_nombre">Nombre(s) <span class="required">*</span></label>
                                <input type="text" name="enlace_nombre" required id="enlace_nombre">
                            </div>
                            <div class="form-group">
                                <label for="enlace_apellido1">Primer Apellido <span class="required">*</span></label>
                                <input type="text" name="enlace_apellido1" required id="enlace_apellido1">
                            </div>
                            <div class="form-group">
                                <label for="enlace_apellido2">Segundo Apellido <span class="required">*</span></label>
                                <input type="text" name="enlace_apellido2" required id="enlace_apellido2">
                            </div>
                            <div class="form-group">
                                <label for="enlace_correo">Correo Institucional <span class="required">*</span></label>
                                <input type="email" name="enlace_correo" required id="enlace_correo">
                            </div>
                            <div class="form-group">
                                <label for="enlace_telefono">TelÃ©fono Institucional con ExtensiÃ³n <span class="required">*</span></label>
                                <input type="tel" name="enlace_telefono" placeholder="55-1234-5678 ext. 123" required id="enlace_telefono">
                            </div>
                        </div>

                        <h3 style="color: var(--guinda); margin: 2rem 0 1.5rem;">ðŸ“ Registro de Persona Servidora PÃºblica Interesada</h3>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="trimestre">Trimestre <span class="required">*</span></label>
                                <select name="trimestre" required id="trimestre">
                                    <option value="">Seleccione...</option>
                                    <option value="ABRIL_JUNIO">ABRIL - JUNIO</option>
                                    <option value="JULIO_SEPTIEMBRE">JULIO - SEPTIEMBRE</option>
                                    <option value="OCTUBRE_DICIEMBRE">OCTUBRE - DICIEMBRE</option>
                                    <option value="ENERO_MARZO">ENERO - MARZO</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="id_rusp">ID RUSP <span class="required">*</span></label>
                                <input type="text" name="id_rusp" placeholder="NÃºmero de identificaciÃ³n" required id="id_rusp">
                            </div>
                            <div class="form-group">
                                <label for="primer_apellido">Primer Apellido <span class="required">*</span></label>
                                <input type="text" name="primer_apellido" required id="primer_apellido">
                            </div>
                            <div class="form-group">
                                <label for="segundo_apellido">Segundo Apellido <span class="required">*</span></label>
                                <input type="text" name="segundo_apellido" required id="segundo_apellido">
                            </div>
                            <div class="form-group">
                                <label for="nombre">Nombre(s) <span class="required">*</span></label>
                                <input type="text" name="nombre" required id="nombre">
                            </div>
                            <div class="form-group">
                                <label for="curp">CURP <span class="required">*</span></label>
                                <input type="text" name="curp" maxlength="18" pattern="[A-Z]{4}[0-9]{6}[HM][A-Z]{5}[0-9]{2}" required id="curp">
                            </div>
                            <div class="form-group">
                                <label for="nivel_puesto">Nivel de Puesto <span class="required">*</span></label>
                                <select name="nivel_puesto" required id="nivel_puesto">
                                    <option value="">Seleccione...</option>
                                    <option value="PUESTO_OPERATIVO_U_HOMÃ“LOGO">PUESTO OPERATIVO U HOMÃ“LOGO</option>
                                    <option value="ENLACE_U_HOMÃ“LOGO">ENLACE U HOMÃ“LOGO</option>
                                    <option value="JEFE_DE_DEPARTAMENTO_U_HOMÃ“LOGO">JEFE DE DEPARTAMENTO U HOMÃ“LOGO</option>
                                    <option value="SUBDIRECTOR_DE_ÃREA_U_HOMÃ“LOGO">SUBDIRECTOR DE ÃREA U HOMÃ“LOGO</option>
                                    <option value="DIRECTOR_DE_ÃREA_U_HOMÃ“LOGO">DIRECTOR DE ÃREA U HOMÃ“LOGO</option>
                                    <option value="COORDINADOR">COORDINADOR</option>
                                    <option value="DIRECTOR_GENERAL_U_HOMÃ“LOGO">DIRECTOR GENERAL U HOMÃ“LOGO</option>
                                    <option value="TITULAR_DE_UNIDAD_O_SUPERIOR">TITULAR DE UNIDAD O SUPERIOR</option>
                                    <option value="OTRO">OTRO</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="nivel_tabular">Nivel Tabular <span class="required">*</span></label>
                                <select name="nivel_tabular" required id="nivel_tabular">
                                    <option value="">Seleccione...</option>
                                    <option value="P11">P11</option>
                                    <option value="P12">P12</option>
                                    <option value="P13">P13</option>
                                    <option value="P21">P21</option>
                                    <option value="P23">P23</option>
                                    <option value="P31">P31</option>
                                    <option value="P32">P32</option>
                                    <option value="P33">P33</option>
                                    <option value="O11">O11</option>
                                    <option value="O21">O21</option>
                                    <option value="O23">O23</option>
                                    <option value="O31">O31</option>
                                    <option value="O32">O32</option>
                                    <option value="O33">O33</option>
                                    <option value="N11">N11</option>
                                    <option value="N21">N21</option>
                                </select>
                            </div>
                            <div class="form-group" style="position: relative;">
                                <label for="ramoUrInput">Ramo - UR <span class="required">*</span></label>
                                <input type="text" name="ramo_ur" id="ramoUrInput" placeholder="Busque o escriba el Ramo-UR (Ej: 13-J3A)" autocomplete="off" required>
                                <div id="ramoUrSuggestions" class="autocomplete-suggestions"></div>
                            </div>
                            <div class="form-group" style="position: relative;">
                                <label for="dependenciaInput">Dependencia <span class="required">*</span></label>
                                <input type="text" name="dependencia" id="dependenciaInput" placeholder="Busque o escriba la Dependencia" autocomplete="off" required>
                                <div id="dependenciaSuggestions" class="autocomplete-suggestions"></div>
                            </div>
                            <div class="form-group">
                                <label for="correo_institucional">Correo Institucional <span class="required">*</span></label>
                                <input type="email" name="correo_institucional" required id="correo_institucional">
                            </div>
                            <div class="form-group">
                                <label for="telefono_institucional">TelÃ©fono Institucional con ExtensiÃ³n <span class="required">*</span></label>
                                <input type="tel" name="telefono_institucional" required id="telefono_institucional">
                            </div>
                            <div class="form-group">
                                <label for="nivel_educativo">Nivel Educativo <span class="required">*</span></label>
                                <select name="nivel_educativo" required id="nivel_educativo">
                                    <option value="">Seleccione...</option>
                                    <option value="PRIMARIA">PRIMARIA</option>
                                    <option value="SECUNDARIA">SECUNDARIA</option>
                                    <option value="BACHILLERATO">BACHILLERATO</option>
                                    <option value="LICENCIATURA">LICENCIATURA</option>
                                    <option value="ESPECIALIDAD">ESPECIALIDAD</option>
                                    <option value="MAESTRÃA">MAESTRÃA</option>
                                    <option value="DOCTORADO">DOCTORADO</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="institucion_educativa">InstituciÃ³n Educativa <span class="required">*</span></label>
                                <select name="institucion_educativa" required id="institucion_educativa">
                                    <option value="">Seleccione...</option>
                                    <option>INSTITUTO NACIONAL PARA LA EDUCACIÃ“N DE ADULTOS (INEA)</option>
                                    <option>COLEGIO DE BACHILLERES (COLBACH)</option>
                                    <option>UNIVERSIDAD ABIERTA Y A DISTANCIA DE MÃ‰XICO (UNADM)</option>
                                    <option>UNIVERSIDAD NACIONAL ROSARIO CASTELLANOS (UNRC)</option>
                                    <option>TECNOLÃ“GICO NACIONAL DE MÃ‰XICO (TECNM)</option>
                                    <option>UNIVERSIDAD INTERNACIONAL DE LA RIOJA (UNIR)</option>
                                    <option>SECRETARÃA DE EDUCACIÃ“N PÃšBLICA</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="modalidad">Modalidad <span class="required">*</span></label>
                                <select name="modalidad" required id="modalidad">
                                    <option value="">Seleccione...</option>
                                    <option value="GUÃA DE ESTUDIO â€“ EXAMEN ÃšNICO (INEA)">GUÃA DE ESTUDIO â€“ EXAMEN ÃšNICO (INEA)</option>
                                    <option value="APRENDE INEA EN LÃNEA">APRENDE INEA EN LÃNEA</option>
                                    <option value="PRESENCIAL MEV (INEA)">PRESENCIAL MEV (INEA)</option>
                                    <option value="CERTIFICACIÃ“N POR EVALUACIONES PARCIALES (COLBACH)">CERTIFICACIÃ“N POR EVALUACIONES PARCIALES (COLBACH)</option>
                                    <option value="SISTEMA DE ENSEÃ‘ANZA ABIERTA SEA (COLBACH)">SISTEMA DE ENSEÃ‘ANZA ABIERTA SEA (COLBACH)</option>
                                    <option value="NO ESCOLARIZADA/VIRTUAL">NO ESCOLARIZADA/VIRTUAL</option>
                                    <option value="A DISTANCIA">A DISTANCIA</option>
                                    <option value="PRESENCIAL">PRESENCIAL</option>
                                    <option value="ESCOLARIZADA">ESCOLARIZADA</option>
                                    <option value="MIXTO">MIXTO</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="estado_avance">Estado de Avance <span class="required">*</span></label>
                                <select name="estado_avance" required id="estado_avance">
                                    <option value="">Seleccione...</option>
                                    <option value="PERSONA INTERESADA">PERSONA INTERESADA</option>
                                    <option value="PERSONA INSCRITA">PERSONA INSCRITA</option>
                                    <option value="PERSONA CURSANDO NIVEL EDUCATIVO">PERSONA CURSANDO NIVEL EDUCATIVO</option>
                                    <option value="PERSONA QUE CONCLUYÃ“ SUS ESTUDIOS">PERSONA QUE CONCLUYÃ“ SUS ESTUDIOS</option>
                                    <option value="PERSONA EN PROCESO DE TITULACIÃ“N">PERSONA EN PROCESO DE TITULACIÃ“N</option>
                                    <option value="PERSONA SUSPENDIDA">PERSONA SUSPENDIDA</option>
                                    <option value="CAMBIÃ“ LA INSTITUCIÃ“N ACADÃ‰MICA DE INTERÃ‰S">CAMBIÃ“ LA INSTITUCIÃ“N ACADÃ‰MICA DE INTERÃ‰S</option>
                                    <option value="PERSONA QUE DESERTÃ“">PERSONA QUE DESERTÃ“</option>
                                    <option value="OTRA">OTRA</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="observaciones">Observaciones</label>
                            <textarea name="observaciones" rows="4" placeholder="Ingrese observaciones adicionales (opcional)" id="observaciones"></textarea>
                        </div>

                        <div style="text-align: center; margin-top: 2rem;">
                        <button type="submit" class="btn">ðŸ’¾ Guardar Registro</button>
                    </div>
                    </form>
                </div>
                <!-- TAB: TABLA DE REGISTROS (Solo visible para Super Admin) -->
                <div id="tabla" class="tab-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                        <h3 style="color: var(--guinda);">ðŸ“‹ Tabla de Registros - Control DCEVE</h3>
                    </div>
                    <input type="text" id="searchTableTrimestral" class="search-box" placeholder="ðŸ” Buscar en la tabla...">
                   <div id="exportButtonsTrimestral" class="hidden" style="margin-bottom: 1rem;">
                    <div class="actions-bar">
                        <button class="btn btn-success" onclick="exportData('excel')">ðŸ“¥ Exportar a Excel</button>
                        <button class="btn btn-success" onclick="exportData('csv')">ðŸ“¥ Exportar a CSV</button>

                        <!-- Solo administradores: carga masiva vÃ­a Excel -->
                        <input type="file" id="excelFile" accept=".csv,.xlsx,.xls" style="position:absolute; left:-9999px; width:1px; height:1px; opacity:0;" onchange="uploadExcel()" />
                        <div id="excelUploadBox" class="hidden" style="display:inline-flex; gap:14px; align-items:center;">
                            <label class="btn btn-success admin-only" for="excelFile" style="margin:0; cursor:pointer;">ðŸ“Ž Seleccionar carga de Excel</label>
                        </div>
                    </div>
                </div>
                    <div class="table-container">
                        <table id="registrosTable">
                            <thead>
                                <tr>
                                    <th>NÂ°</th>
                                    <th>TRIMESTRE</th>
                                    <th>ID RUSP</th>
                                    <th>PRIMER APELLIDO</th>
                                    <th>SEGUNDO APELLIDO</th>
                                    <th>NOMBRE(S)</th>
                                    <th>CURP</th>
                                    <th>NIVEL DE PUESTO</th>
                                    <th>NIVEL TABULAR</th>
                                    <th>RAMO - UR</th>
                                    <th>DEPENDENCIA</th>
                                    <th>CORREO INSTITUCIONAL</th>
                                    <th>TELÃ‰FONO</th>
                                    <th>NIVEL EDUCATIVO</th>
                                    <th>INSTITUCIÃ“N EDUCATIVA</th>
                                    <th>MODALIDAD</th>
                                    <th>ESTADO DE AVANCE</th>
                                    <th>OBSERVACIONES</th>
                                    <th>ENLACE NOMBRE(S)</th>
                                    <th>ENLACE PRIMER APELLIDO</th>
                                    <th>ENLACE SEGUNDO APELLIDO</th>
                                    <th>ENLACE CORREO</th>
                                    <th>ENLACE TELÃ‰FONO</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>1</td>
                                    <td>ABRIL_JUNIO</td>
                                    <td>123456</td>
                                    <td>RODRÃGUEZ</td>
                                    <td>MARTÃNEZ</td>
                                    <td>JOSÃ‰ JUAN</td>
                                    <td>ABCDE1234</td>
                                    <td>ENLACE U HOMÃ“LOGO</td>
                                    <td>P13</td>
                                    <td>13-J3A</td>
                                    <td>. SIST. PORTUARIO NAL. ALTAMIRA</td>
                                    <td>correo@institucional.gob.mx</td>
                                    <td>12345 EXT. 123</td>
                                    <td class="editable-cell" data-field="nivel_educativo" onclick="makeEditable(this)" role="button" tabindex="0">
                                        SECUNDARIA
                                        <span class="edit-icon">âœï¸</span>
                                    </td>
                                    <td class="editable-cell" data-field="institucion_educativa" onclick="makeEditable(this)" role="button" tabindex="0">
                                        INEA
                                        <span class="edit-icon">âœï¸</span>
                                    </td>
                                    <td class="editable-cell" data-field="modalidad" onclick="makeEditable(this)" role="button" tabindex="0">
                                        APRENDE INEA EN LÃNEA
                                        <span class="edit-icon">âœï¸</span>
                                    </td>
                                    <td class="editable-cell estado-rojo" data-field="estado_avance" onclick="makeEditable(this)" role="button" tabindex="0">
                                        CAMBIÃ“ LA INSTITUCIÃ“N ACADÃ‰MICA DE INTERÃ‰S
                                        <span class="edit-icon">âœï¸</span>
                                    </td>
                                    <td class="editable-cell" data-field="observaciones" onclick="makeEditable(this)" role="button" tabindex="0">
                                        En proceso
                                        <span class="edit-icon">âœï¸</span>
                                    </td>
                                    <td>MarÃ­a</td>
                                    <td>GonzÃ¡lez</td>
                                    <td>PÃ©rez</td>
                                    <td>correo@institucional.gob.mx</td>
                                    <td>55-5555-5555</td>
                                </tr>
                                <tr>
                                    <td>2</td>
                                    <td>JULIO_SEPTIEMBRE</td>
                                    <td>HONORARIOS</td>
                                    <td>RODRIGUEZ</td>
                                    <td>MARTINEZ</td>
                                    <td>JOSÃ‰ JUAN</td>
                                    <td>ABCDE1234</td>
                                    <td>DIRECTOR DE ÃREA U HOMÃ“LOGO</td>
                                    <td>P31</td>
                                    <td>13-J2R</td>
                                    <td>. SIST. PORTUARIO NAL. PROGRESO</td>
                                    <td>correo@institucional.gob.mx</td>
                                    <td>12345 EXT. 123</td>
                                    <td class="editable-cell" data-field="nivel_educativo" onclick="makeEditable(this)" role="button" tabindex="0">
                                        LICENCIATURA
                                        <span class="edit-icon">âœï¸</span>
                                    </td>
                                    <td class="editable-cell" data-field="institucion_educativa" onclick="makeEditable(this)" role="button" tabindex="0">
                                        TECNM
                                        <span class="edit-icon">âœï¸</span>
                                    </td>
                                    <td class="editable-cell" data-field="modalidad" onclick="makeEditable(this)" role="button" tabindex="0">
                                        MIXTO
                                        <span class="edit-icon">âœï¸</span>
                                    </td>
                                    <td class="editable-cell" data-field="estado_avance" onclick="makeEditable(this)" role="button" tabindex="0">
                                        PERSONA INTERESADA
                                        <span class="edit-icon">âœï¸</span>
                                    </td>
                                    <td class="editable-cell" data-field="observaciones" onclick="makeEditable(this)" role="button" tabindex="0">
                                        -
                                        <span class="edit-icon">âœï¸</span>
                                    </td>
                                    <td>Juan</td>
                                    <td>LÃ³pez</td>
                                    <td>RamÃ­rez</td>
                                    <td>correo@institucional.gob.mx</td>
                                    <td>55-6666-6666</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div id="notasTablaTrimestral" class="info-box hidden" style="margin-top: 2rem;">
                        <h3>âš ï¸ Notas Importantes sobre la Tabla</h3>
                        <ul>
                            <li>Los usuariostados de avance desactualizados se visualizan en color ROJO</li>
                            <li>Las celdas editables muestran un icono de lÃ¡piz âœï¸ al pasar el mouse</li>
                            <li>Haga clic en una celda editable para modificar su contenido</li>
                            <li>Los cambios se guardan automÃ¡ticamente al presionar Enter o al salir del campo</li>
                            <li>La DCEVE controla el bloqueo/desbloqueo de ediciÃ³n de datos</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECCIÃ“N: EVIDENCIAS MENSUALES -->
        <div id="evidencias" class="main-section">
            
            <!-- Sub-secciÃ³n: Registro de Evidencias -->
            <div id="registro" class="subsection active">
                <div class="card">
                    <h2>ðŸ“„ Reporte de Evidencias Mensuales</h2>
<!-- =========================
     SUBIR EVIDENCIAS (PDF)
     ========================= -->
<div class="note-box" style="margin-top:15px;">
  <i class="fas fa-file-pdf"></i>
  <strong>Subir evidencia (PDF):</strong>
  <div style="margin-top:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
    <input id="archivoEvidencia" type="file" accept="application/pdf" />
    <button id="btnEnviarEvidencia" type="button" class="btn btn-primary">
      Enviar Evidencia
    </button>
  </div>
  <div style="margin-top:8px; font-size:12px; color:#6c757d;">
    *Solo PDF. Al enviar, el sistema lo guarda en Drive y devuelve el enlace.
  </div>
</div>
                    
                    <!-- Panel Admin (solo visible para Super Admin) -->
                    <div id="adminPanelEvidencias" class="admin-panel hidden">
                        <h3>âš™ï¸ Panel de Control - </h3>
                        <div class="admin-controls">
                            <button class="btn btn-warning" onclick="togglePanelRevision()">
                                ðŸ‘ï¸ Mostrar/Ocultar Panel de RevisiÃ³n
                            </button>
                        </div>
                    </div>

                    <div class="info-box">
                        <h3>ðŸ“ Instrucciones</h3>
                        <ul>
                            <li>Seleccione el mes para registrar las evidencias correspondientes</li>
                            <li>Las evidencias serÃ¡n almacenadas en una carpeta de Google Drive correspondiente al mes de entrega</li>
                            <li>El archivo debe ser en formato PDF Ãºnicamente</li>
                            <li>Nombrar el archivo con las siglas de la dependencia y el mes (Ejemplo: INALI_noviembre, IMSS_noviembre)</li>
                            <li>Complete todos los datos del Enlace de FormaciÃ³n AcadÃ©mica</li>
                        </ul>
                    </div>

                    <h3 style="color: var(--guinda); margin: 2rem 0 1.5rem;">ðŸ“… Seleccione el Mes</h3>
                    
                    <div class="month-grid">
                        <div class="month-card" onclick="openMonthModal('Enero')" style="background: var(--gradient1);" role="button" tabindex="0">
                            <h3>â„ï¸ Enero</h3>
                            <p>2025</p>
                        </div>
                        <div class="month-card" onclick="openMonthModal('Febrero')" style="background: var(--gradient2);" role="button" tabindex="0">
                            <h3>ðŸ’ Febrero</h3>
                            <p>2025</p>
                        </div>
                        <div class="month-card" onclick="openMonthModal('Marzo')" style="background: var(--gradient3);" role="button" tabindex="0">
                            <h3>ðŸŒ¸ Marzo</h3>
                            <p>2025</p>
                        </div>
                        <div class="month-card" onclick="openMonthModal('Abril')" style="background: var(--gradient4);" role="button" tabindex="0">
                            <h3>ðŸŒ¼ Abril</h3>
                            <p>2025</p>
                        </div>
                        <div class="month-card" onclick="openMonthModal('Mayo')" style="background: var(--gradient1);" role="button" tabindex="0">
                            <h3>ðŸŒ» Mayo</h3>
                            <p>2025</p>
                        </div>
                        <div class="month-card" onclick="openMonthModal('Junio')" style="background: var(--gradient2);" role="button" tabindex="0">
                            <h3>â˜€ï¸ Junio</h3>
                            <p>2025</p>
                        </div>

                        <div class="month-card" onclick="openMonthModal('Julio')" style="background: var(--gradient3);" role="button" tabindex="0">
                            <h3>ðŸŽ† Julio</h3>
                            <p>2025</p>
                        </div>
                        <div class="month-card" onclick="openMonthModal('Agosto')" style="background: var(--gradient4);" role="button" tabindex="0">
                            <h3>ðŸŒ§ï¸ Agosto</h3>
                            <p>2025</p>
                        </div>
                        <div class="month-card" onclick="openMonthModal('Septiembre')" style="background: var(--gradient1);" role="button" tabindex="0">
                            <h3>ðŸ‡²ðŸ‡½ Septiembre</h3>
                            <p>2025</p>
                        </div>
                        <div class="month-card" onclick="openMonthModal('Octubre')" style="background: var(--gradient2);" role="button" tabindex="0">
                            <h3>ðŸŽƒ Octubre</h3>
                            <p>2025</p>
                        </div>
                        <div class="month-card" onclick="openMonthModal('Noviembre')" style="background: var(--gradient3);" role="button" tabindex="0">
                            <h3>ðŸ•¯ï¸ Noviembre</h3>
                            <p>2025</p>
                        </div>
                        <div class="month-card" onclick="openMonthModal('Diciembre')" style="background: var(--gradient4);" role="button" tabindex="0">
                            <h3>ðŸŽ„ Diciembre</h3>
                            <p>2025</p>
                        </div>
                    </div>
                    <div class="month-card" onclick="openMonthModal('Febrero')" style="background: var(--gradient2);" role="button" tabindex="0">
                            <h3>ðŸ’ Febrero</h3>
                            <p>2025</p>
                        </div>
                        <div class="month-card" onclick="openMonthModal('Marzo')" style="background: var(--gradient3);" role="button" tabindex="0">
                            <h3>ðŸŒ¸ Marzo</h3>
                            <p>2025</p>
                        </div>
                        <div class="month-card" onclick="openMonthModal('Abril')" style="background: var(--gradient4);" role="button" tabindex="0">
                            <h3>ðŸŒ¼ Abril</h3>
                            <p>2025</p>
                        </div>
                        <div class="month-card" onclick="openMonthModal('Mayo')" style="background: var(--gradient1);" role="button" tabindex="0">
                            <h3>ðŸŒ» Mayo</h3>
                            <p>2025</p>
                        </div>
                        <div class="month-card" onclick="openMonthModal('Junio')" style="background: var(--gradient2);" role="button" tabindex="0">
                            <h3>â˜€ï¸ Junio</h3>
                            <p>2025</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sub-secciÃ³n: Panel de RevisiÃ³n DCEVE -->
            <div id="revision" class="subsection">
                <div class="card">
                    <h2>ðŸ” RevisiÃ³n de Evidencias Mensuales - Panel DCEVE</h2>
                    
                    <div class="info-box">
                        <h3>ðŸ“‹ Panel de Control DCEVE</h3>
                        <ul>
                            <li>Visualice las evidencias registradas por las dependencias</li>
                            <li>Descargue los archivos PDF adjuntos</li>
                            <li>Marque como "Completado" o "Sin completar" segÃºn la revisiÃ³n</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Registro de Evidencias -->
    <div id="monthModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()" role="button" tabindex="0">&times;</span>
            <h2 id="modalTitle" style="color: var(--guinda); margin-bottom: 2rem;">Registro de Evidencias Mensuales</h2>
            
            <form id="evidenciaForm" onsubmit="submitEvidencia(event)">
                <h3 style="color: var(--guinda); margin-bottom: 1.5rem;">ðŸ“‹ Datos del Enlace de FormaciÃ³n AcadÃ©mica que Registra</h3>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nombre(s) <span class="required">*</span></label>
                        <input type="text" id="ev_nombre" required>
                    </div>
                    <div class="form-group">
                        <label>Primer Apellido <span class="required">*</span></label>
                        <input type="text" id="ev_ap1" required>
                    </div>
                    <div class="form-group">
                        <label>Segundo Apellido <span class="required">*</span></label>
                        <input type="text" id="ev_ap2" required>
                    </div>
                    <div class="form-group">
                        <label>Correo Institucional <span class="required">*</span></label>
                        <input type="email" id="ev_correo" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>ðŸ“Ž Carga de Archivo PDF <span class="required">*</span></label>
                    <div class="file-upload" id="fileUpload" onclick="document.getElementById('pdfFile').click()">
                        <p style="font-size: 3rem; margin-bottom: 1rem;">ðŸ“„</p>
                        <p style="font-size: 1.2rem; font-weight: bold;">Haga clic o arrastre el archivo PDF aquÃ­</p>
                        <p style="color: #64748b; margin-top: 0.5rem;">Solo se permiten archivos PDF</p>
                        <input type="file" id="pdfFile" accept=".pdf" style="display: none;" required>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 2rem;">
                    <button type="submit" class="btn">ðŸ“¤ Enviar Evidencia</button>
                    <button type="button" class="btn btn-danger" onclick="closeModal()">âŒ Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- â¬‡ï¸ MODAL REGISTRO USUARIO â¬‡ï¸ -->
 <div id="registroModal" class="modal hidden">
    <div class="modal-content">
        <h3>ðŸ“ Registro de Usuario</h3>
        
        <form id="formRegistro" onsubmit="event.preventDefault(); registrarUsuario();">
            <input
                id="reg_curp"
                type="tel"
                placeholder="CURP (18 caracteres)"
                required
                maxlength="18"
                minlength="18"
                style="text-transform: uppercase;"
                autocomplete="off"
                autocorrect="off"
                autocapitalize="characters"
                inputmode="text"
            />
            <input
                id="reg_nombre"
                type="text"
                placeholder="Nombre(s)"
                required
            />
            <input
                id="reg_primer_apellido"
                type="text"
                placeholder="Primer Apellido"
                required
            />
            <input
                id="reg_segundo_apellido"
                type="text"
                placeholder="Segundo Apellido"
                required
            />
            <input
                id="reg_correo"
                type="email"
                placeholder="Correo ElectrÃ³nico"
                required
            />
            <div class="dep-autocomplete">
            <input
                id="reg_dependencia"
                type="text"
                placeholder="Dependencia / InstituciÃ³n"
                required
                autocomplete="off"
                aria-autocomplete="list"
                aria-controls="dep_reg_menu"
                aria-expanded="false"
            />
            <div id="dep_reg_menu" class="autocomplete-menu" role="listbox" aria-label="Dependencias"></div>
            <datalist id="dep_reg_list"></datalist>
        </div>
<input
                id="reg_usuario"
                type="text"
                placeholder="Usuario"
                required
                minlength="3"
                maxlength="20"
                style="text-transform: uppercase;"
            />
            <input
                id="reg_password"
                type="password"
                placeholder="ContraseÃ±a (mÃ­nimo 6 caracteres)"
                required
                minlength="6"
            />
            <div class="modal-actions">
                <button type="submit">Registrar</button>
                <button type="button" onclick="cerrarRegistro()">Cancelar</button>
            </div>
        </form>
    </div>
</div>
    <!-- â¬‡ï¸ MODAL RESTAURAR CONTRASEÃ‘A â¬‡ï¸ -->
    <div id="restaurarPasswordModal" class="modal hidden">
        <div class="modal-content">
            <h3>ðŸ”‘ Restaurar ContraseÃ±a</h3>
            
            <form id="formRestaurarPassword" onsubmit="event.preventDefault(); restaurarPassword();">
                <p style="color: #64748b; margin-bottom: 1.5rem; text-align: center;">
                    Ingresa tu usuario y te enviaremos instrucciones para restaurar tu contraseÃ±a.
                </p>
                
                <input
                    id="restore_usuario"
                    type="text"
                    placeholder="Usuario"
                    required
                    minlength="3"
                />
                
                <input
                    id="restore_email"
                    type="email"
                    placeholder="Correo institucional"
                    required
                />
                
                <div class="modal-actions">
                    <button type="submit">Enviar Instrucciones</button>
                    <button type="button" onclick="cerrarRestaurarPassword()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
    <div class="fab" onclick="window.scrollTo({top: 0, behavior: 'smooth'})" role="button" tabindex="0">â¬†ï¸</div>
    <footer>
        <img src="data:image/webp;base64,UklGRuglAABXRUJQVlA4WAoAAAAwAAAAnAEAPQAASUNDUMgBAAAAAAHIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAACRyWFlaAAABFAAAABRnWFlaAAABKAAAABRiWFlaAAABPAAAABR3dHB0AAABUAAAABRyVFJDAAABZAAAAChnVFJDAAABZAAAAChiVFJDAAABZAAAAChjcHJ0AAABjAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEJYWVogAAAAAAAAb6IAADj1AAADkFhZWiAAAAAAAABimQAAt4UAABjaWFlaIAAAAAAAACSgAAAPhAAAts9YWVogAAAAAAAA9tYAAQAAAADTLXBhcmEAAAAAAAQAAAACZmYAAPKnAAANWQAAE9AAAApbAAAAAAAAAABtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACAAAAAcAEcAbwBvAGcAbABlACAASQBuAGMALgAgADIAMAAxADY=" alt="Gobierno de MÃ©xico - SABG">
        <p style="font-size: 1.2rem; font-weight: bold;">Gobierno de MÃ©xico</p>
        <p>SecretarÃ­a AnticorrupciÃ³n y Buen Gobierno</p>
        <p>Sistema de PromociÃ³n de la FormaciÃ³n AcadÃ©mica</p>
        <p style="margin-top: 1rem; color: #94a3b8;">Â© 2025 - Todos los derechos reservados</p>
    </footer>
        <script>
const API_BASE = "";
const LOGIN_URL = API_BASE + "/api/auth/login";

// ===================== FIX: Evitar ReferenceError si falta updateStatsFromRegistros =====================
if (typeof window.updateStatsFromRegistros !== 'function') {
  window.updateStatsFromRegistros = function(registros) {
    try {
      if (!Array.isArray(registros)) return;

      // Actualiza un contador genÃ©rico si existe (no rompe si no existe)
      const totalRegistrosEl = document.getElementById('totalRegistros');
      if (totalRegistrosEl) {
        totalRegistrosEl.textContent = registros.length.toLocaleString('es-MX');
      }
    } catch (e) {
      console.warn('updateStatsFromRegistros fallback:', e);
    }
  };
}
// =======================================================================================================

    // ========================================
    // SISTEMA DE ROLES Y VARIABLES GLOBALES
    // ========================================
    let userRole = 'enlace';

/* =========================================================
   SEGURIDAD (doble validaciÃ³n) + AUDITORÃA SILENCIOSA
   - No muestra roles en UI
   - Bloquea acciones crÃ­ticas si no es superadmin
   - Registra acciones en localStorage y (opcional) envÃ­a a /api/audit/log
========================================================= */
function isSuperAdmin() {
    return (userRole === 'superadmin');
}

function requireSuperAdmin(actionLabel) {
    if (isSuperAdmin()) return true;
    // Mensaje genÃ©rico (sin exponer roles)
    alert('âš ï¸ Acceso restringido.');
    // AuditorÃ­a de intento no autorizado
    auditLog(actionLabel, 'DENIED', { reason: 'not_superadmin' });
    return false;
}


// ========================================
// VISIBILIDAD POR ROL (sin exponer roles)
// - "Cargar Excel" solo para administradores
// ========================================
function isAdminUser() {
    // Evita ReferenceError si 'userRole' no existe en el scope global
    const roleRaw =
        (typeof userRole !== 'undefined' && userRole) ? userRole :
        (localStorage.getItem('SABG_ROL') || '');
    const role = String(roleRaw).toLowerCase().trim();
    return role === 'admin' || role === 'superadmin' || role.includes('admin');
}


function applyRoleVisibility() {
    const excelBox = document.getElementById('excelUploadBox');
    if (excelBox) {
        if (isAdminUser()) excelBox.classList.remove('hidden');
        else excelBox.classList.add('hidden');
    }

}
// ========================================
// Carga masiva (Admin): CSV exportado desde Excel
// Nota: Para evitar dependencias extra en el frontend, el cargador soporta CSV.
// Si necesitas XLSX directo, se implementa del lado del servidor o con SheetJS.
// ========================================
function normalizeHeaderKey(h) {
    return String(h || '')
        .toLowerCase()
        .trim()
        .replace(/\u00e1/g,'a').replace(/\u00e9/g,'e').replace(/\u00ed/g,'i').replace(/\u00f3/g,'o').replace(/\u00fa/g,'u').replace(/\u00f1/g,'n')
        .replace(/[^a-z0-9]+/g, '_')
        .replace(/^_+|_+$/g, '');
}

function parseCSV(text) {
    // Parser CSV simple con soporte de comillas dobles
    const rows = [];
    let row = [];
    let cur = '';
    let inQuotes = false;

    for (let i = 0; i < text.length; i++) {
        const c = text[i];
        const next = text[i + 1];

        if (c === '"') {
            if (inQuotes && next === '"') { // escape ""
                cur += '"';
                i++;
            } else {
                inQuotes = !inQuotes;
            }
            continue;
        }

        if (!inQuotes && (c === ',' || c === ';')) {
            row.push(cur);
            cur = '';
            continue;
        }

        if (!inQuotes && (c === '\n' || c === '\r')) {
            if (c === '\r' && next === '\n') i++; // Windows CRLF
            row.push(cur);
            rows.push(row);
            row = [];
            cur = '';
            continue;
        }

        cur += c;
    }

    // Ãºltima celda
    if (cur.length || row.length) {
        row.push(cur);
        rows.push(row);
    }

    // limpiar filas vacÃ­as
    return rows.filter(r => r.some(cell => String(cell || '').trim() !== ''));
}


function triggerExcelUpload() {
    try {
        if (!isAdminUser()) {
            alert('â›” Solo administradores pueden cargar archivos.');
            return;
        }
        const input = document.getElementById('excelFile');
        if (!input) {
            alert('No se encontrÃ³ el selector de archivo.');
            return;
        }
        // Reset para permitir seleccionar el mismo archivo otra vez
        input.value = '';
        input.click();
    } catch (e) {
        console.error(e);
        alert('Error al abrir el selector de archivo.');
    }
}

// ===== Anti doble carga (global, sin romper nada) =====
window.__uploadInProgress = false;
window.__lastUploadSig = null;

function fileSignature(file) {
  // firma simple: nombre + tamaÃ±o + lastModified
  if (!file) return null;
  return `${file.name}__${file.size}__${file.lastModified}`;
}
// ===== UI: Modal de reporte de carga masiva (bonito y trazable) =====
(function ensureBulkReportStyles(){
  if (document.getElementById('bulkReportStyles')) return;
  const style = document.createElement('style');
  style.id = 'bulkReportStyles';
  style.textContent = `
    .bulk-report-overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:flex; align-items:center; justify-content:center;
      z-index:999999;
    }
    .bulk-report-modal{
      width:min(920px, 94vw);
      max-height:86vh;
      overflow:auto;
      background:#fff;
      border-radius:14px;
      box-shadow:0 20px 60px rgba(0,0,0,.35);
      padding:18px 18px 14px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .bulk-report-head{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      border-bottom:1px solid rgba(0,0,0,.08);
      padding-bottom:10px; margin-bottom:12px;
    }
    .bulk-report-head h3{ margin:0; font-size:18px; }
    .bulk-report-sub{ margin:4px 0 0; color:#555; font-size:13px; line-height:1.35; }
    .bulk-report-close{
      border:0; background:#111; color:#fff;
      padding:8px 12px; border-radius:10px; cursor:pointer;
      font-size:13px;
    }
    .bulk-kpis{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:10px;
      margin:10px 0 14px;
    }
    .bulk-kpi{
      border:1px solid rgba(0,0,0,.08);
      border-radius:12px;
      padding:10px 12px;
      background:rgba(0,0,0,.02);
    }
    .bulk-kpi .label{ color:#666; font-size:12px; }
    .bulk-kpi .value{ font-size:20px; font-weight:700; margin-top:2px; }
    .bulk-kpi .hint{ color:#777; font-size:12px; margin-top:4px; line-height:1.25; }
    .bulk-report-section{ margin-top:10px; }
    .bulk-report-section h4{ margin:10px 0 8px; font-size:14px; }
    .bulk-report-table{
      width:100%;
      border-collapse:collapse;
      font-size:12.5px;
      border:1px solid rgba(0,0,0,.08);
      border-radius:12px;
      overflow:hidden;
    }
    .bulk-report-table th, .bulk-report-table td{
      padding:9px 10px;
      border-bottom:1px solid rgba(0,0,0,.06);
      vertical-align:top;
    }
    .bulk-report-table th{
      background:rgba(0,0,0,.03);
      text-align:left;
      font-weight:650;
    }
    .bulk-report-badge{
      display:inline-block;
      padding:4px 8px;
      border-radius:999px;
      font-size:12px;
      background:rgba(0,0,0,.06);
    }
    .bulk-report-badge.ok{ background:rgba(34,197,94,.15); }
    .bulk-report-badge.warn{ background:rgba(245,158,11,.18); }
    .bulk-report-badge.err{ background:rgba(239,68,68,.15); }
    details.bulk-details summary{ cursor:pointer; font-weight:650; margin:6px 0; }
    .bulk-mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  `;
  document.head.appendChild(style);
})();

function showBulkReportModal(aggregateReport, extra={}){
  try{
    // Cerrar si ya existe
    const prev = document.getElementById('bulkReportOverlay');
    if (prev) prev.remove();

    const rep = aggregateReport || {};
    const inserted = Number(rep.inserted || rep.insertados || rep.count || 0);
    const ok = Number(inserted || 0);
    const dup = Number(rep.duplicates_omitted || 0);
    const empty = Number(rep.empty_discarded || 0);
    const invCurp = Number(rep.curp_invalid_to_null || 0);
    const errorsCount = Number(rep.errors_count || 0);
    const received = Number(rep.received || 0);
    const processed = Number(rep.processed || 0);

    const statusClass = errorsCount > 0 ? 'warn' : 'ok';
    const statusText = errorsCount > 0 ? 'Carga parcial / con observaciones' : 'Carga completada';
    const overlay = document.createElement('div');
    overlay.id = 'bulkReportOverlay';
    overlay.className = 'bulk-report-overlay';
    overlay.addEventListener('click', (e)=>{ if(e.target === overlay) overlay.remove(); });

    const modal = document.createElement('div');
    modal.className = 'bulk-report-modal';

    const head = document.createElement('div');
    head.className = 'bulk-report-head';
    head.innerHTML = `
      <div>
        <h3>ðŸ“¦ Reporte de carga masiva <span class="bulk-report-badge ${statusClass}">${statusText}</span></h3>
        <div class="bulk-report-sub">
          Recibidos: <b>${received}</b> Â· Procesados: <b>${processed}</b> Â· Insertados: <b>${inserted}</b>
          ${dup ? ` Â· Duplicados omitidos: <b>${dup}</b>` : ''}
          ${empty ? ` Â· Filas vacÃ­as descartadas: <b>${empty}</b>` : ''}
        </div>
      </div>
      <button class="bulk-report-close" type="button">Cerrar</button>
    `;
    head.querySelector('.bulk-report-close').addEventListener('click', ()=> overlay.remove());

    const kpis = document.createElement('div');
    kpis.className = 'bulk-kpis';
    kpis.innerHTML = `
      <div class="bulk-kpi"><div class="label">Insertados</div><div class="value">${inserted}</div><div class="hint">Registros guardados en la tabla</div></div>
      <div class="bulk-kpi"><div class="label">Duplicados omitidos</div><div class="value">${dup}</div><div class="hint">Requiere UNIQUE (curp, trimestre) WHERE curp IS NOT NULL</div></div>
      <div class="bulk-kpi"><div class="label">CURP invÃ¡lida â†’ NULL</div><div class="value">${invCurp}</div><div class="hint">CURP vacÃ­a o invÃ¡lida se guarda como NULL</div></div>
      <div class="bulk-kpi"><div class="label">Filas vacÃ­as descartadas</div><div class="value">${empty}</div><div class="hint">Filas sin datos (solo espacios / tÃ­tulos)</div></div>
      <div class="bulk-kpi"><div class="label">Errores</div><div class="value">${errorsCount}</div><div class="hint">Si hay, revisa detalle abajo</div></div>
      <div class="bulk-kpi"><div class="label">Recibidos</div><div class="value">${received}</div><div class="hint">Filas recibidas del frontend</div></div>
    `;

    const section = document.createElement('div');
    section.className = 'bulk-report-section';

    const errors = Array.isArray(rep.errors) ? rep.errors : [];
    const showErrors = errors.length > 0 || errorsCount > 0;

    let errorsHtml = '';
    if (showErrors){
      const rows = errors.slice(0, 50).map((e, idx)=>{
        const msg = (e && (e.message || e.error)) ? (e.message || e.error) : JSON.stringify(e);
        const curp = e?.curp ?? '';
        const tri = e?.trimestre ?? '';
        const rusp = e?.id_rusp ?? '';
        const nombre = [e?.nombre, e?.primer_apellido, e?.segundo_apellido].filter(Boolean).join(' ');
        return `
          <tr>
            <td>${idx+1}</td>
            <td class="bulk-mono">${String(tri||'').slice(0,40)}</td>
            <td class="bulk-mono">${String(curp||'').slice(0,24)}</td>
            <td class="bulk-mono">${String(rusp||'').slice(0,30)}</td>
            <td>${String(nombre||'').slice(0,120)}</td>
            <td class="bulk-mono">${String(msg||'').slice(0,260)}</td>
          </tr>
        `;
      }).join('');

      errorsHtml = `
        <details class="bulk-details" open>
          <summary>ðŸ§¾ Detalle de errores (${errorsCount || errors.length})</summary>
          <table class="bulk-report-table">
            <thead>
              <tr>
                <th>#</th><th>Trimestre</th><th>CURP</th><th>ID RUSP</th><th>Nombre</th><th>Error</th>
              </tr>
            </thead>
            <tbody>${rows || `<tr><td colspan="6">No hay detalle disponible.</td></tr>`}</tbody>
          </table>
        </details>
      `;
    }

    // Extra raw summary (opcional)
    const raw = extra?.raw ? String(extra.raw).slice(0, 1200) : '';
    const rawHtml = raw ? `
      <details class="bulk-details">
        <summary>ðŸ§  Respuesta cruda (debug)</summary>
        <pre class="bulk-mono" style="white-space:pre-wrap; margin:8px 0; background:rgba(0,0,0,.03); padding:10px; border-radius:12px;">${raw.replace(/[<>&]/g, (m)=>({ '<':'&lt;','>':'&gt;','&':'&amp;' }[m]))}</pre>
      </details>
    ` : '';

    section.innerHTML = `
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <span class="bulk-report-badge ${statusClass}">Insertados: ${inserted}</span>
        ${dup ? `<span class="bulk-report-badge">Omitidos por duplicado: ${dup}</span>` : ''}
        ${invCurp ? `<span class="bulk-report-badge">CURP invÃ¡lidaâ†’NULL: ${invCurp}</span>` : ''}
        ${empty ? `<span class="bulk-report-badge">Filas vacÃ­as: ${empty}</span>` : ''}
        ${errorsCount ? `<span class="bulk-report-badge err">Errores: ${errorsCount}</span>` : ''}
      </div>
      ${errorsHtml}
      ${rawHtml}
    `;

    modal.appendChild(head);
    modal.appendChild(kpis);
    modal.appendChild(section);
    overlay.appendChild(modal);
    document.body.appendChild(overlay);
  }catch(e){
    console.error('No se pudo mostrar modal de reporte:', e);
    alert('âœ… Carga completada. (No se pudo renderizar el reporte visual; revisa consola).');
  }
}





async function uploadExcel() {
  // ==== BLOQUEO DE DOBLE CARGA ====
  if (window.__uploadInProgress) {
    alert('âš ï¸ Ya hay una carga en proceso. Espera a que termine para evitar duplicados.');
    return;
  }

  // Detectar el input file (busca el primero type="file" si no hay id conocido)
  const input = document.getElementById('excelFile') || document.querySelector('input[type="file"]');
  const file = input?.files?.[0];
  const sig = fileSignature(file);

  if (sig && window.__lastUploadSig === sig) {
    alert('âš ï¸ Este mismo archivo ya se intentÃ³ cargar. Si necesitas recargarlo, selecciona el archivo nuevamente (o refresca la pÃ¡gina) y vuelve a intentar.');
    return;
  }

  window.__uploadInProgress = true;
  window.__lastUploadSig = sig;

    try {
        if (!isAdminUser()) {
            alert('â›” Solo administradores pueden cargar archivos.');
            return;
        }

        const input = document.getElementById('excelFile');
        const file = input && input.files ? input.files[0] : null;

        if (!file) {
            alert('ðŸ“Ž Primero selecciona un archivo.');
            return;
        }

        const filename = String(file.name || '').toLowerCase();

        // Overlay
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) overlay.classList.add('active');
        const loadingText = document.querySelector('.loading-text');
        if (loadingText) loadingText.textContent = 'ðŸ“¥ Procesando archivo...';

        if (filename.endsWith('.csv')) {
            const text = await file.text();
            const rows = parseCSV(text);

            if (!rows || rows.length < 2) {
                alert('âš ï¸ El CSV no tiene registros (o estÃ¡ vacÃ­o).');
                return;
            }

            
            // Detectar fila de encabezados (algunos CSV traen filas extra antes del header)
            const normRows = rows.map(r => (r || []).map(c => normalizeHeaderKey(c)));
            const expectedCandidates = [
                'trimestre','trim','periodo',
                'id_rusp','rusp','idrusp',
                'primer_apellido','apellido_paterno','ap_paterno','paterno',
                'segundo_apellido','apellido_materno','ap_materno','materno',
                'nombre','nombres','nombre_s',
                'curp',
                'correo_institucional','correo','email','e_mail',
                'telefono_institucional','telefono','tel','telefono_oficina',
                'nivel_educativo','nivel_de_estudios','nivel_estudios',
                'institucion_educativa','institucion','escuela',
                'modalidad',
                'estado_avance','avance','estatus',
                'observaciones','obs','comentarios',
                'enlace_nombre','enlace_primer_apellido','enlace_segundo_apellido','enlace_correo','enlace_telefono',
                'nivel_puesto','nivel_tabular','ramo_ur','dependencia'
            ];

            let headerIdx = 0;
            let bestScore = -1;

            // Busca en las primeras 25 filas la que parezca encabezado
            const scanMax = Math.min(normRows.length, 25);
            for (let i = 0; i < scanMax; i++) {
                const row = normRows[i] || [];
                let score = 0;
                for (const c of expectedCandidates) {
                    if (row.includes(normalizeHeaderKey(c))) score++;
                }
                if (score > bestScore) {
                    bestScore = score;
                    headerIdx = i;
                }
            }

            if (bestScore < 2) {
                // No encontramos encabezados vÃ¡lidos: evita "0 guardados" engaÃ±oso
                const preview = (rows[0] || []).slice(0, 12).join(' | ');
                alert('âš ï¸ No se detectaron encabezados vÃ¡lidos en el CSV.\n\n' + 'AsegÃºrate de exportar como CSV desde la pestaÃ±a correcta y que la primera fila contenga columnas como TRIMESTRE, ID_RUSP, CURP, etc.\n\n' + 'Vista previa de la primera fila:\n' + preview);
                return;
            }

            const headerRow = normRows[headerIdx];
            const bodyRows = rows.slice(headerIdx + 1);


            // Mapeos comunes (por si los encabezados vienen en espaÃ±ol)
            const alias = {
                trimestre: ['trimestre', 'trim', 'periodo'],
                id_rusp: ['id_rusp', 'rusp', 'idrusp'],
                primer_apellido: ['primer_apellido', 'apellido_paterno', 'ap_paterno', 'paterno'],
                segundo_apellido: ['segundo_apellido', 'apellido_materno', 'ap_materno', 'materno'],
                nombre: ['nombre', 'nombres', 'nombre_s'],
                curp: ['curp'],
                correo_institucional: ['correo_institucional', 'correo', 'email', 'e_mail'],
                telefono_institucional: ['telefono_institucional', 'telefono', 'tel', 'telefono_oficina'],
                nivel_educativo: ['nivel_educativo', 'nivel_de_estudios', 'nivel_estudios'],
                institucion_educativa: ['institucion_educativa', 'institucion', 'escuela'],
                modalidad: ['modalidad'],
                estado_avance: ['estado_avance', 'avance', 'estatus'],
                observaciones: ['observaciones', 'obs', 'comentarios']
            ,
                enlace_nombre: ['enlace_nombre', 'enlace nombre', 'nombre_enlace', 'enlace'],
                enlace_primer_apellido: ['enlace_primer_apellido', 'enlace primer apellido', 'primer_apellido_enlace', 'apellido_paterno_enlace'],
                enlace_segundo_apellido: ['enlace_segundo_apellido', 'enlace segundo apellido', 'segundo_apellido_enlace', 'apellido_materno_enlace'],
                enlace_correo: ['enlace_correo', 'correo_enlace', 'email_enlace', 'correo del enlace'],
                enlace_telefono: ['enlace_telefono', 'telefono_enlace', 'tel_enlace', 'telefono del enlace'],
                nivel_puesto: ['nivel_puesto', 'nivel de puesto', 'puesto', 'nivel puesto'],
                nivel_tabular: ['nivel_tabular', 'nivel tabular', 'tabular', 'nivel tab'],
                ramo_ur: ['ramo_ur', 'ramo-ur', 'ramo ur', 'ur', 'ramo'],
                dependencia: ['dependencia', 'institucion', 'dependencia/entidad', 'entidad']

            };

            function findIndexForKey(key) {
                const candidates = alias[key] || [key];
                for (const cand of candidates) {
                    const idx = headerRow.indexOf(normalizeHeaderKey(cand));
                    if (idx !== -1) return idx;
                }
                return -1;
            }

            // Resolver Ã­ndices
            const idxMap = {};
            Object.keys(alias).forEach(k => { idxMap[k] = findIndexForKey(k); });

            let ok = 0;
            let fail = 0;
            const errors = [];

            // Construir todos los payloads primero (sin spamear el backend)
            const allPayloads = [];

            for (let r = 0; r < bodyRows.length; r++) {
                const row = bodyRows[r];

                // construir payload
                const payload = {};
                Object.keys(idxMap).forEach(k => {
                    const idx = idxMap[k];
                    payload[k] = idx >= 0 ? String(row[idx] || '').trim() : '';
                });

                // valores por defecto
                payload.usuario_registro = userName || '';

                // omitir filas vacÃ­as
                const hasData = Object.keys(payload).some(k => k !== 'usuario_registro' && String(payload[k] || '').trim() !== '');
                if (!hasData) continue;

                allPayloads.push(payload);
            }

            if (allPayloads.length === 0) {
                alert('âš ï¸ No se detectaron filas con datos para cargar.');
                return;
            }

            
// Enviar por lotes ESTABLE para archivos grandes (30k+)
// - Lotes pequeÃ±os
// - Concurrencia controlada (2)
// - Reintentos por lote
// - ReanudaciÃ³n automÃ¡tica si se recarga (localStorage)
const BATCH = 120;          // recomendado para 30k (ajustable)
const CONCURRENCY = 2;      // estable en Vercel
const MAX_RETRIES = 3;
const RESUME_KEY = 'SABG_TRIM_BULK_CURSOR_V1';

// Construir lotes
const batches = [];
for (let i = 0; i < allPayloads.length; i += BATCH) {
    batches.push(allPayloads.slice(i, i + BATCH));
}

// Cursor (reanudaciÃ³n)
let cursor = 0;
try { cursor = Number(localStorage.getItem(RESUME_KEY) || '0') || 0; } catch (_) { cursor = 0; }
if (cursor < 0) cursor = 0;
if (cursor >= batches.length) cursor = 0;

// Totales
let insertedTotal = 0;
let skippedTotal = 0; // compat (si backend reporta omitidos)
let backendErrorsTotal = 0;
let duplicatesOmittedTotal = 0;

// Reporte agregado (sumado por lotes)
const agg = {
    received: 0,
    empty_discarded: 0,
    processed: 0,
    curp_invalid_to_null: 0,
    inserted: 0,
    duplicates_omitted: 0,
    errors_count: 0,
    errors: []
};

// Helper: POST robusto
async function postBulk(batch) {
    let resp, rawText;
    let result = {};
    for (let attempt = 1; attempt <= MAX_RETRIES; attempt++) {
        try {
            resp = await fetch('/api/trimestral/bulkCreate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ rows: batch })
            });

            rawText = await resp.text();
            try { result = JSON.parse(rawText); } catch (_) { result = {}; }

            const success = (result && (result.success === true || result.ok === true));
            if (resp.ok && success) {
                // Normalizar formato nuevo a legacy
                if (result.ok === true && result.afectados != null && !result.report) {
                    result.report = {
                        received: batch.length,
                        processed: batch.length,
                        inserted: Number(result.afectados) || 0,
                        duplicates_omitted: 0,
                        errors_count: Number(result.errores) || 0,
                        errors: []
                    };
                    result.success = true;
                }
                return { ok: true, result };
            }

            const detail = (result && (result.message || result.error)) ? (result.message || result.error) : (rawText || 'Sin detalle');
            console.warn(`bulkCreate intento ${attempt}/${MAX_RETRIES} fallÃ³: HTTP ${resp.status}`, detail);

        } catch (err) {
            console.warn(`bulkCreate intento ${attempt}/${MAX_RETRIES} error:`, err);
            rawText = String(err?.message || err || 'Error');
            result = {};
        }

        await new Promise(r => setTimeout(r, 350 * attempt));
    }
    const status = resp ? resp.status : 'NO_RESP';
    const detail = (result && (result.message || result.error)) ? (result.message || result.error) : (rawText || 'Sin detalle');
    return { ok: false, status, detail };
}

// Cola concurrente
let nextIndex = cursor;
async function worker() {
    while (nextIndex < batches.length) {
        const myIndex = nextIndex++;
        const batch = batches[myIndex];

        // Progreso (aprox)
        const processedSoFar = Math.min((myIndex * BATCH), allPayloads.length);
        if (loadingText) {
            loadingText.textContent = `ðŸ“¥ Cargando... ${processedSoFar}/${allPayloads.length} (insertados: ${insertedTotal})`;
        }

        const resp = await postBulk(batch);

        if (!resp.ok) {
            errors.push(`Lote ${myIndex + 1}/${batches.length}: HTTP ${resp.status} - ${String(resp.detail).slice(0, 1200)}`);
            console.error('bulkCreate error FINAL', resp.status, resp.detail);
            fail += batch.length;

            // Guardar avance (reanudaciÃ³n)
            try { localStorage.setItem(RESUME_KEY, String(myIndex + 1)); } catch (_) {}
            continue;
        }

        const result = resp.result;
        const rep = (result && result.report) ? result.report : (result || {});

        // Agregados trazables (sumados por lote)
        agg.received += Number(rep.received || batch.length || 0);
        agg.empty_discarded += Number(rep.empty_discarded || 0);
        agg.processed += Number(rep.processed || batch.length || 0);
        agg.curp_invalid_to_null += Number(rep.curp_invalid_to_null || 0);

        const ins = Number(rep.inserted || 0);
        const dup = Number(rep.duplicates_omitted || 0);
        const errc = Number(rep.errors_count || 0);

        insertedTotal += ins;
        duplicatesOmittedTotal += dup;
        backendErrorsTotal += errc;

        // Guardar detalle de errores (hasta 50 en total)
        if (Array.isArray(rep.errors) && rep.errors.length) {
            for (const e of rep.errors) {
                if (agg.errors.length >= 50) break;
                agg.errors.push(e);
            }
        }

        // Guardar avance (reanudaciÃ³n)
        try { localStorage.setItem(RESUME_KEY, String(myIndex + 1)); } catch (_) {}
    }
}

// Lanzar workers
const workers = [];
for (let w = 0; w < CONCURRENCY; w++) workers.push(worker());
await Promise.all(workers);

// Terminado: limpiar cursor
try { localStorage.removeItem(RESUME_KEY); } catch (_) {}

            ok = insertedTotal;

            // Completar reporte agregado
            agg.inserted = insertedTotal;
            agg.duplicates_omitted = duplicatesOmittedTotal;
            agg.errors_count = backendErrorsTotal;

            // Consideramos como "fail" los errores de backend reportados (si los hay) + lotes fallidos (ya sumados arriba)
            fail += backendErrorsTotal;
// refrescar tabla
            if (typeof cargarRegistrosTrimestral === 'function') {
                await cargarRegistrosTrimestral();
            }

            // Mostrar reporte visual (bonito)
            showBulkReportModal(agg, { raw: (typeof rawText !== 'undefined' ? rawText : '') });

            // Mensaje corto (por si el usuario no ve el modal)
            if (fail === 0) {
                console.log(`âœ… Carga completada: ${ok} insertados. Omitidos por duplicado: ${duplicatesOmittedTotal}.`);
            } else {
                console.warn('Errores de carga masiva:', errors);
                console.warn(`âš ï¸ Carga parcial: ${ok} insertados / ${fail} con error.`);
            }
        } else {
            alert('â„¹ï¸ Por ahora, la carga masiva soporta CSV (exportado desde Excel).\n\n1) En Excel: Archivo â†’ Guardar como â†’ CSV\n2) SÃºbelo aquÃ­ y se registrarÃ¡ fila por fila.');
        }
    } finally {
        
    window.__uploadInProgress = false;
const overlay = document.getElementById('loadingOverlay');
        if (overlay) overlay.classList.remove('active');
        const input = document.getElementById('excelFile');
        if (input) input.value = ''; // limpiar para permitir volver a seleccionar
    }
}
// Exponer para handlers inline
window.uploadExcel = uploadExcel;


function auditLog(action, status, details = {}) {
    try {
        const entry = {
            ts: new Date().toISOString(),
            action,
            status,
            user: (localStorage.getItem('SABG_USUARIO') || ''),
            name: (typeof userName !== 'undefined' ? userName : ''),
            dependencia: (typeof userDependencia !== 'undefined' ? userDependencia : ''),
            role: (typeof userRole !== 'undefined' ? userRole : ''),
            details
        };

        // Guardar local (auditorÃ­a silenciosa)
        const key = 'SABG_AUDIT_LOG';
        const arr = JSON.parse(localStorage.getItem(key) || '[]');
        arr.push(entry);
        // Mantener tamaÃ±o razonable
        if (arr.length > 500) arr.splice(0, arr.length - 500);
        localStorage.setItem(key, JSON.stringify(arr));

        // EnvÃ­o opcional al backend (si existe). No rompe si no hay endpoint.
        fetch('/api/audit/log', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(entry)
        }).catch(() => {}).catch(() => {});
    } catch (e) {
        // Silencioso: no romper la app
    }


function formatNumberMX(n){
    try{
        return new Intl.NumberFormat('es-MX').format(Number(n) || 0);
    }catch(e){
        return (Number(n)||0).toString();
    }
}

function updateStatsFromRegistros(registros){
    try{
        const total = Array.isArray(registros) ? registros.length : 0;

        const uniqDependencias = new Set();
        const uniqCurp = new Set();

        let activos = 0;

        (registros || []).forEach(r => {
            const dep = (r.dependencia || '').trim();
            if(dep) uniqDependencias.add(dep);

            const curp = (r.curp || '').trim();
            if(curp) uniqCurp.add(curp);

            // Consideramos "activo" todo lo que NO sea deserciÃ³n
            const estado = (r.estado_avance || '').trim().toUpperCase();
            if(estado && estado !== 'PERSONA QUE DESERTÃ“') activos += 1;
        });

        const dependencias = uniqDependencias.size;
        const servidores = uniqCurp.size || total;

        const cumplimiento = total > 0 ? Math.round((activos / total) * 100) : 0;

        const elDep = document.getElementById('statDependencias');
        const elSrv = document.getElementById('statServidores');
        const elCum = document.getElementById('statCumplimiento');
        const elAct = document.getElementById('statActivos');

        if(elDep) elDep.textContent = formatNumberMX(dependencias);
        if(elSrv) elSrv.textContent = formatNumberMX(servidores);
        if(elCum) elCum.textContent = (cumplimiento + '%');
        if(elAct) elAct.textContent = formatNumberMX(activos);
    }catch(e){
        // silencioso
    }
}

}
    let edicionBloqueada = true;
    let userDependencia = null;
    let userName = '';

    // Base de datos de usuarios (en producciÃ³n esto vendrÃ­a de un backend)
    const usuarios = {
        // Super Admin
        '': { 
            password: 'admin2024', 
            role: 'superadmin',
            dependencia: null,
            nombre: 'Administrador'
        },
        // Dependencias
        'SABG': { 
            password: 'sabg2024', 
            role: 'enlace',
            dependencia: 'SECRETARÃA ANTICORRUPCIÃ“N Y BUEN GOBIERNO',
            nombre: 'Enlace SABG'
        },
        'SCT': { 
            password: 'sct2024', 
            role: 'enlace',
            dependencia: 'SECRETARÃA DE COMUNICACIONES Y TRANSPORTES',
            nombre: 'Enlace SCT'
        },
        'SHCP': { 
            password: 'shcp2024', 
            role: 'enlace',
            dependencia: 'SECRETARÃA DE HACIENDA Y CRÃ‰DITO PÃšBLICO',
            nombre: 'Enlace SHCP'
        },
        'SEP': { 
            password: 'sep2024', 
            role: 'enlace',
            dependencia: 'SECRETARÃA DE EDUCACIÃ“N PÃšBLICA',
            nombre: 'Enlace SEP'
        },
        'ALTAMIRA': { 
            password: 'altamira2024', 
            role: 'enlace',
            dependencia: 'ISTRACIÃ“N DEL SISTEMA PORTUARIO NACIONAL ALTAMIRA',
            nombre: 'Enlace Altamira'
        },
        'PROGRESO': { 
            password: 'progreso2024', 
            role: 'enlace',
            dependencia: 'ISTRACIÃ“N DEL SISTEMA PORTUARIO NACIONAL PROGRESO',
            nombre: 'Enlace Progreso'
        }
    };

    // ========================================
    // FUNCIONES DE AUTENTICACIÃ“N
    // ========================================
     // Control Modal Registro
    function mostrarRegistro() {
        document.getElementById("registroModal").classList.remove("hidden");
    }

    function cerrarRegistro() {
        document.getElementById("registroModal").classList.add("hidden");
        document.getElementById("reg_usuario").value = "";
        const regDep = document.getElementById("reg_dependencia") || document.getElementById("reg_institucion");
        if (regDep) regDep.value = "";
        document.getElementById("reg_password").value = "";
    }

    // ========================================
    // RESTAURAR CONTRASEÃ‘A
    // ========================================
    
    function mostrarRestaurarPassword() {
        document.getElementById("restaurarPasswordModal").classList.remove("hidden");
    }

    function cerrarRestaurarPassword() {
        document.getElementById("restaurarPasswordModal").classList.add("hidden");
        document.getElementById("restore_usuario").value = "";
        document.getElementById("restore_email").value = "";
    }

    async function restaurarPassword() {
        const usuarioInput = document.getElementById("restore_usuario");
        const emailInput = document.getElementById("restore_email");

        const usuario = usuarioInput.value.trim();
        const email = emailInput.value.trim();

        if (!usuario || !email) {
            alert("âŒ Completa todos los campos");
            return;
        }

        try {
            alert(`ðŸ“§ Se han enviado las instrucciones para restaurar tu contraseÃ±a al correo:\n\n${email}\n\nPor favor revisa tu bandeja de entrada y spam.\n\nNota: Esta funcionalidad estÃ¡ en desarrollo. Por favor contacta al administrador.`);
            cerrarRestaurarPassword();
            
        } catch (error) {
            alert("âŒ Error de conexiÃ³n con el servidor");
        }
    }
            // ========================================
// LOGIN DE USUARIO
// ========================================

// ========================================
// LOGIN DE USUARIO
// ========================================
async function loginUsuario() {
    const usuario = document.getElementById("usuario").value.trim();
    const password = document.getElementById("password").value.trim();

    if (!usuario || !password) {
        alert("âŒ Por favor completa todos los campos");
        return;
    }

    try {
        document.getElementById('loadingOverlay')?.classList.add('active');

        // âœ… ÃšNICA RUTA
        const response = await fetch('/api/auth/login', {
  credentials: 'include', credentials: 'include' },, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({ usuario, password })
        });

        // Leer respuesta de forma segura (evita: Unexpected token / [object Object])
        const contentType = response.headers.get('content-type') || '';
        let data;
        if (contentType.includes('application/json')) {
            data = await response.json();
        } else {
            const text = await response.text();
            throw new Error(`Respuesta no JSON (HTTP ${response.status}). ${text.slice(0,120)}`);
        }

        if (!response.ok || !data?.success) {
            const msg = data?.error || data?.message || `Error HTTP ${response.status}`;
            throw new Error(msg);
        }

        // âœ… Variables de sesiÃ³n (en memoria)
        userRole = data.rol;
        userName = data.nombre;
        userDependencia = data.dependencia;

        // âœ… Persistir para refrescos/permiso (sin token por ahora)
        localStorage.setItem('SABG_USUARIO', data.usuario || usuario);
        localStorage.setItem('SABG_NOMBRE', data.nombre || '');
        localStorage.setItem('SABG_ROL', data.rol || '');
        localStorage.setItem('SABG_DEPENDENCIA', data.dependencia || '');

        // Aplicar permisos visuales por rol
        applyRoleVisibility();

        // AuditorÃ­a
        try { auditLog('LOGIN', 'OK', { usuario: (data.usuario || usuario) }); } catch(e) {}

        // UI
        const userNameEl = document.getElementById('userName');
        if (userNameEl) userNameEl.textContent = `ðŸ‘¤ ${data.nombre}`;
        const userRoleEl = document.getElementById('userRole');
        if (userRoleEl) userRoleEl.textContent = '';

        document.getElementById('loginScreen')?.classList.add('hidden');

        // Visibilidad estricta de controles admin
        const adminEls = [
            'adminPanelTrimestral',
            'exportButtonsTrimestral',
            'estadoEdicion',
            'notasTablaTrimestral'
        ];
        adminEls.forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            if (userRole === 'superadmin') el.classList.remove('hidden');
            else el.classList.add('hidden');
        });

        if (userRole === 'superadmin') {
            document.getElementById('adminPanelTrimestral')?.classList.remove('hidden');
            document.getElementById('exportButtonsTrimestral')?.classList.remove('hidden');
            document.getElementById('estadoEdicion')?.classList.remove('hidden');
            document.getElementById('notasTablaTrimestral')?.classList.remove('hidden');
            document.getElementById('adminPanelEvidencias')?.classList.remove('hidden');
            document.getElementById('tabVerTabla')?.classList.remove('hidden');
            document.getElementById('dropdownItemTabla')?.classList.remove('admin-only');
            document.getElementById('dropdownItemRevision')?.classList.remove('admin-only');
        }

        await cargarRegistrosTrimestral();

        // Refresco cada 60s
        try {
            if (window.__rtTrimestralInterval) clearInterval(window.__rtTrimestralInterval);
            window.__rtTrimestralInterval = setInterval(() => {
                const u = localStorage.getItem('SABG_USUARIO');
                if (u) cargarRegistrosTrimestral();
            }, 60000);
        } catch (e) {}

        alert(`âœ… Â¡Bienvenido ${data.nombre}!`);

    } catch (error) {
        // Nunca alert(objeto)
        alert('âŒ ' + (error?.message || 'Error de conexiÃ³n con el servidor'));
    } finally {
        document.getElementById('loadingOverlay')?.classList.remove('active');
    }
}

// Login de Usuario (FUNCIÃ“N COMPLETA)

   async function registrarUsuario() {
    // Obtener valores y limpiar
    let curp = document.getElementById("reg_curp").value || "";
    let nombre = document.getElementById("reg_nombre").value || "";
    let primer_apellido = document.getElementById("reg_primer_apellido").value || "";
    let segundo_apellido = document.getElementById("reg_segundo_apellido").value || "";
    let correo = document.getElementById("reg_correo").value || "";
    let dependencia = document.getElementById("reg_dependencia").value || "";
    let usuario = document.getElementById("reg_usuario").value || "";
    let password = document.getElementById("reg_password").value || "";

    // Limpiar espacios y convertir a mayÃºsculas donde corresponda
    curp = curp.trim().toUpperCase();
    nombre = nombre.trim();
    primer_apellido = primer_apellido.trim();
    segundo_apellido = segundo_apellido.trim();
    correo = correo.trim().toLowerCase();
    dependencia = dependencia.trim();
    usuario = usuario.trim().toUpperCase();
    password = password.trim();

    // Validar campos vacÃ­os
    if (!curp) {
        alert("âŒ El campo CURP es obligatorio");
        document.getElementById("reg_curp").focus();
        return;
    }

    if (!nombre) {
        alert("âŒ El campo Nombre es obligatorio");
        document.getElementById("reg_nombre").focus();
        return;
    }

    if (!primer_apellido) {
        alert("âŒ El campo Primer Apellido es obligatorio");
        document.getElementById("reg_primer_apellido").focus();
        return;
    }

    if (!segundo_apellido) {
        alert("âŒ El campo Segundo Apellido es obligatorio");
        document.getElementById("reg_segundo_apellido").focus();
        return;
    }

    if (!correo) {
        alert("âŒ El campo Correo es obligatorio");
        document.getElementById("reg_correo").focus();
        return;
    }

    if (!dependencia) {
        alert("âŒ El campo Dependencia es obligatorio");
        document.getElementById("reg_dependencia").focus();
        return;
    }

    if (!usuario) {
        alert("âŒ El campo Usuario es obligatorio");
        document.getElementById("reg_usuario").focus();
        return;
    }

    if (!password) {
        alert("âŒ El campo ContraseÃ±a es obligatorio");
        document.getElementById("reg_password").focus();
        return;
    }

    // Validar longitud CURP
    if (curp.length !== 18) {
        alert("âŒ CURP invÃ¡lido\n\nDebe tener exactamente 18 caracteres.\nActualmente tiene: " + curp.length + " caracteres");
        document.getElementById("reg_curp").focus();
        return;
    }

    // Validar formato CURP
    const curpPattern = /^[A-Z]{4}[0-9]{6}[HM][A-Z]{5}[0-9]{2}$/;
    if (!curpPattern.test(curp)) {
        alert("âŒ Formato de CURP invÃ¡lido\n\nFormato correcto:\nâ€¢ 4 letras\nâ€¢ 6 nÃºmeros\nâ€¢ H o M\nâ€¢ 5 letras\nâ€¢ 2 nÃºmeros\n\nEjemplo: SALR990312MDFLPC06");
        document.getElementById("reg_curp").focus();
        return;
    }

    // Validar usuario
    if (usuario.length < 3) {
        alert("âŒ El usuario debe tener al menos 3 caracteres");
        document.getElementById("reg_usuario").focus();
        return;
    }

    // Validar contraseÃ±a
    if (password.length < 6) {
        alert("âŒ La contraseÃ±a debe tener al menos 6 caracteres");
        document.getElementById("reg_password").focus();
        return;
    }

    // Validar email
    const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailPattern.test(correo)) {
        alert("âŒ Formato de correo electrÃ³nico invÃ¡lido");
        document.getElementById("reg_correo").focus();
        return;
    }

    try {
        const response = await fetch('/api/auth/register', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({ 
                curp: curp,
                nombre: nombre,
                primer_apellido: primer_apellido,
                segundo_apellido: segundo_apellido,
                correo: correo,
                dependencia: dependencia,
                usuario: usuario,
                password: password
            })
        });

        const data = await response.json();

        if (data.success) {
            alert("âœ… Usuario registrado correctamente\n\nðŸ‘¤ Usuario: " + data.usuario + "\n\nðŸ”‘ Ya puedes iniciar sesiÃ³n con tus credenciales.");
            cerrarRegistro();
            document.getElementById("formRegistro").reset();
        } else {
            alert("âŒ Error al registrar:\n\n" + data.error);
        }
        
    } catch (error) {
        alert("âŒ Error de conexiÃ³n con el servidor.\n\nPor favor verifica tu conexiÃ³n a internet e intenta nuevamente.");
    }
}

    // Logout
    function logout() {
        if (confirm('Â¿EstÃ¡ seguro que desea cerrar sesiÃ³n?')) {
            document.getElementById('usuario').value = '';
            document.getElementById('password').value = '';
            
            userRole = 'enlace';
            userDependencia = null;
            userName = '';
            
            localStorage.removeItem('SABG_TOKEN');
            localStorage.removeItem('SABG_USUARIO');
            localStorage.removeItem('SABG_NOMBRE');
            localStorage.removeItem('SABG_ROL');
            localStorage.removeItem('SABG_DEPENDENCIA');
            document.getElementById('loginScreen').classList.remove('hidden');
            
            document.querySelectorAll('#registrosTable tbody tr').forEach(row => {
                row.style.display = '';
            });
            
            setTimeout(() => {
                alert('ðŸ‘‹ SesiÃ³n cerrada exitosamente\n\nÂ¡Hasta pronto!');
            }, 300);
        }
    }

    // ========================================
    // FUNCIONES DE NAVEGACIÃ“N
    // ========================================

    function toggleDropdown(dropdownId, btn) {
        document.querySelectorAll('.dropdown-menu').forEach(menu => {
            if (menu.id !== dropdownId) {
                menu.classList.remove('show');
            }
        });
        
        document.querySelectorAll('.main-nav-btn').forEach(button => {
            if (button !== btn) {
                button.classList.remove('expanded');
            }
        });
        
        const dropdown = document.getElementById(dropdownId);
        dropdown.classList.toggle('show');
        btn.classList.toggle('expanded');
    }

    document.addEventListener('click', function(event) {
        if (!event.target.closest('.nav-item')) {
            document.querySelectorAll('.dropdown-menu').forEach(menu => {
                menu.classList.remove('show');
            });
            document.querySelectorAll('.main-nav-btn').forEach(btn => {
                btn.classList.remove('expanded');
            });
        }
    });

    function showSectionAndTab(sectionId, tabId) {
        document.querySelectorAll('.dropdown-menu').forEach(menu => {
            menu.classList.remove('show');
        });
        document.querySelectorAll('.main-nav-btn').forEach(btn => {
            btn.classList.remove('expanded');
        });
        
        document.querySelectorAll('.main-nav-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        document.querySelectorAll('.main-section').forEach(section => {
            section.classList.remove('active');
        });
        
        document.getElementById(sectionId).classList.add('active');
        
        if (sectionId === 'trimestral') {
            document.querySelectorAll('#trimestral .tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelectorAll('#trimestral .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabId).classList.add('active');
            
            const tabs = document.querySelectorAll('#trimestral .tab');
            tabs.forEach(tab => {
                if ((tabId === 'instructivo' && tab.textContent.includes('Instructivo')) ||
                    (tabId === 'formulario' && tab.textContent.includes('Formulario')) ||
                    (tabId === 'tabla' && tab.textContent.includes('Tabla'))) {
                    tab.classList.add('active');
                }
            });
            
            if (tabId === 'tabla') {
                setTimeout(() => {
                    filtrarTablaPorDependencia();
                }, 100);
            }
        }
        
        if (sectionId === 'evidencias') {
            document.querySelectorAll('#evidencias .subsection').forEach(subsection => {
                subsection.classList.remove('active');
            });
            
            document.getElementById(tabId).classList.add('active');
        }
    
        // âœ… Cargar datos reales al abrir la pestaÃ±a "Tabla de Registros" (evita que se queden filas de muestra)
        if (sectionId === 'trimestral' && tabId === 'tabla') {
            try { cargarRegistrosTrimestral(); } catch (e) { console.warn('No se pudieron cargar registros:', e); }
        }

}

    function showMainSection(sectionId) {
        document.querySelectorAll('.dropdown-menu').forEach(menu => {
            menu.classList.remove('show');
        });
        document.querySelectorAll('.main-nav-btn').forEach(btn => {
            btn.classList.remove('expanded');
        });
        
        const sections = document.querySelectorAll('.main-section');
        const navButtons = document.querySelectorAll('.main-nav-btn');

        sections.forEach(section => {
            section.classList.remove('active');
        });

        navButtons.forEach(btn => {
            btn.classList.remove('active');
        });

        document.getElementById(sectionId).classList.add('active');
        
        navButtons.forEach(btn => {
            if (btn.textContent.includes('Inicio') && sectionId === 'inicio') {
                btn.classList.add('active');
            }
        });
    }

    function showTrimestralTab(tabId) {
        // âœ… Acceso a la tabla habilitado para todos los usuarios
const tabs = document.querySelectorAll('#trimestral .tab');
        const tabContents = document.querySelectorAll('#trimestral .tab-content');

        tabs.forEach(tab => {
            tab.classList.remove('active');
        });

        tabContents.forEach(content => {
            content.classList.remove('active');
        });

        tabs.forEach(tab => {
            if ((tabId === 'instructivo' && tab.textContent.includes('Instructivo')) ||
                (tabId === 'formulario' && tab.textContent.includes('Formulario')) ||
                (tabId === 'tabla' && tab.textContent.includes('Tabla'))) {
                tab.classList.add('active');
            }
        });

        document.getElementById(tabId).classList.add('active');
    }

    // ========================================
    // FUNCIONES DE ISTRACIÃ“N
    // ========================================
    function togglePanelRevision() {
        const panel = document.getElementById('revision');
        
        if (panel.classList.contains('active')) {
            panel.classList.remove('active');
            document.getElementById('registro').classList.add('active');
            alert('ðŸ”’ Panel de RevisiÃ³n DCEVE ahora oculto');
        } else {
            panel.classList.add('active');
            document.getElementById('registro').classList.remove('active');
            alert('âœ… Panel de RevisiÃ³n DCEVE ahora visible');
        }
    }

    function desbloquearEdicion() {
        if (!requireSuperAdmin('UNLOCK_EDIT')) return;

        edicionBloqueada = false;
        const estado = document.getElementById('estadoEdicion');
        if (estado) {
            estado.innerHTML = 'ðŸ”“ EdiciÃ³n DESBLOQUEADA';
            estado.style.background = 'linear-gradient(135deg, #10b981, #059669)';
            estado.classList.remove('hidden');
        }

        document.querySelectorAll('.editable-cell').forEach(cell => {
            cell.classList.remove('editable-disabled');
        });

        auditLog('UNLOCK_EDIT', 'OK', { section: 'trimestral' });
        alert('âœ… EdiciÃ³n desbloqueada.');
    }

    function bloquearEdicion() {
        if (!requireSuperAdmin('LOCK_EDIT')) return;

        edicionBloqueada = true;
        const estado = document.getElementById('estadoEdicion');
        if (estado) {
            estado.innerHTML = 'ðŸ”’ EdiciÃ³n BLOQUEADA';
            estado.style.background = 'var(--gradient1)';
            estado.classList.remove('hidden');
        }

        document.querySelectorAll('.editable-cell').forEach(cell => {
            cell.classList.add('editable-disabled');
        });

        auditLog('LOCK_EDIT', 'OK', { section: 'trimestral' });
        alert('ðŸ”’ EdiciÃ³n bloqueada.');
    }

    function filtrarTablaPorDependencia() {
        if (userRole === 'superadmin') {
            document.querySelectorAll('#registrosTable tbody tr').forEach(row => {
                row.style.display = '';
            });
            return;
        }
        
        const rows = document.querySelectorAll('#registrosTable tbody tr');
        let visibleCount = 0;
        
        rows.forEach(row => {
            const cells = row.cells;
            if (cells && cells.length > 10) {
                const dependenciaCell = cells[10].textContent.trim();
                
                if (dependenciaCell.toUpperCase().includes(userDependencia.toUpperCase()) ||
                    userDependencia.toUpperCase().includes(dependenciaCell.toUpperCase())) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            }
        });
        
        if (visibleCount === 0) {
        }
    }

    function makeEditable(cell) {
        const field = cell.dataset.field;

        // âœ… Regla solicitada:
        // - TODOS los usuarios pueden editar SOLO OBSERVACIONES (mÃ¡x. 150 caracteres)
        // - Cualquier otro campo: SOLO superadmin
        const puedeEditar =
            (field === 'observaciones') ||
            (userRole === 'superadmin');

        if (!puedeEditar) {
            alert('âš ï¸ Solo se puede editar la columna OBSERVACIONES.');
            return;
        }

        // ðŸ”“ Para OBSERVACIONES: permitir ediciÃ³n incluso si el control global estÃ¡ bloqueado
        if (field !== 'observaciones' && edicionBloqueada) {
            alert('ðŸ”’ La ediciÃ³n estÃ¡ bloqueada. Por favor, desbloquee la ediciÃ³n primero.');
            return;
        }

        if (cell.classList.contains('editing')) {
            return;
        }

        const currentValue = cell.textContent.trim().replace('âœï¸', '').trim();
        cell.classList.add('editing');

        let editControl;

        if (field === 'nivel_educativo') {
            editControl = document.createElement('select');
            editControl.innerHTML = `
                <option value="PRIMARIA">PRIMARIA</option>
                <option value="SECUNDARIA">SECUNDARIA</option>
                <option value="BACHILLERATO">BACHILLERATO</option>
                <option value="LICENCIATURA">LICENCIATURA</option>
                <option value="ESPECIALIDAD">ESPECIALIDAD</option>
                <option value="MAESTRÃA">MAESTRÃA</option>
                <option value="DOCTORADO">DOCTORADO</option>
            `;
            editControl.value = currentValue;
        }
        else if (field === 'institucion_educativa') {
            editControl = document.createElement('select');
            editControl.innerHTML = `
                <option value="INEA">INEA</option>
                <option value="COLBACH">COLBACH</option>
                <option value="UNADM">UNADM</option>
                <option value="UNRC">UNRC</option>
                <option value="TECNM">TECNM</option>
                <option value="UNIR">UNIR</option>
                <option value="SEP">SEP</option>
            `;
            editControl.value = currentValue;
        }
        else if (field === 'modalidad') {
            editControl = document.createElement('select');
            editControl.innerHTML = `
                <option value="GUÃA DE ESTUDIO â€“ EXAMEN ÃšNICO (INEA)">GUÃA DE ESTUDIO â€“ EXAMEN ÃšNICO (INEA)</option>
                <option value="APRENDE INEA EN LÃNEA">APRENDE INEA EN LÃNEA</option>
                <option value="PRESENCIAL MEV (INEA)">PRESENCIAL MEV (INEA)</option>
                <option value="NO ESCOLARIZADA/VIRTUAL">NO ESCOLARIZADA/VIRTUAL</option>
                <option value="A DISTANCIA">A DISTANCIA</option>
                <option value="PRESENCIAL">PRESENCIAL</option>
                <option value="ESCOLARIZADA">ESCOLARIZADA</option>
                <option value="MIXTO">MIXTO</option>
            `;
            editControl.value = currentValue;
        }
        else if (field === 'estado_avance') {
            editControl = document.createElement('select');
            editControl.innerHTML = `
                <option value="CAMBIÃ“ LA INSTITUCIÃ“N ACADÃ‰MICA DE INTERÃ‰S">CAMBIÃ“ LA INSTITUCIÃ“N ACADÃ‰MICA DE INTERÃ‰S</option>
                <option value="PERSONA INTERESADA">PERSONA INTERESADA</option>
                <option value="PERSONA INSCRITA">PERSONA INSCRITA</option>
                <option value="PERSONA CURSANDO NIVEL EDUCATIVO">PERSONA CURSANDO NIVEL EDUCATIVO</option>
                <option value="PERSONA QUE CONCLUYÃ“ SUS ESTUDIOS">PERSONA QUE CONCLUYÃ“ SUS ESTUDIOS</option>
                <option value="PERSONA EN PROCESO DE TITULACIÃ“N">PERSONA EN PROCESO DE TITULACIÃ“N</option>
                <option value="PERSONA QUE DESERTÃ“">PERSONA QUE DESERTÃ“</option>
                <option value="PERSONA SUSPENDIDA">PERSONA SUSPENDIDA</option>
                <option value="OTRA">OTRA</option>
            `;
            editControl.value = currentValue;
        }
        else if (field === 'observaciones') {
            editControl = document.createElement('textarea');
            editControl.className = 'edit-control';
            editControl.maxLength = 150;
            editControl.value = currentValue;

            // Guardar con Enter (Shift+Enter = salto de lÃ­nea)
            editControl.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    saveEdit(cell, field, this.value.trim(), currentValue);
                }
            });

            // Enforce duro al pegar / input
            editControl.addEventListener('input', function () {
                if (this.value.length > 150) this.value = this.value.slice(0, 150);
            });
        }
        else {
            editControl = document.createElement('input');
            editControl.type = 'text';
            editControl.value = currentValue;
            editControl.className = 'edit-control';
        }

        // Para selects/inputs que no sean textarea, asignar clase si no la tienen
        if (!editControl.classList.contains('edit-control')) {
            editControl.classList.add('edit-control');
        }

        cell.innerHTML = '';
        cell.appendChild(editControl);
        editControl.focus();

        // Guardado (no observaciones): Enter guarda y blur guarda
        if (field !== 'observaciones') {
            editControl.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveEdit(cell, field, this.value.trim(), currentValue);
                }
            });

            editControl.addEventListener('blur', function() {
                saveEdit(cell, field, this.value.trim(), currentValue);
            });
        } else {
            // Observaciones: tambiÃ©n guardar al perder foco
            editControl.addEventListener('blur', function() {
                saveEdit(cell, field, this.value.trim(), currentValue);
            });
        }
    }

    // ========================================
    // FUNCIONES DE UTILIDAD
    // ========================================

    function createParticles() {
        const particlesContainer = document.getElementById('particles');
        const particleCount = 50;

        for (let i = 0; i < particleCount; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.width = Math.random() * 5 + 2 + 'px';
            particle.style.height = particle.style.width;
            particle.style.left = Math.random() * 100 + '%';
            particle.style.top = Math.random() * 100 + '%';
            particle.style.animationDuration = Math.random() * 20 + 10 + 's';
            particle.style.animationDelay = Math.random() * 5 + 's';
            particlesContainer.appendChild(particle);
        }
    }

    function openMonthModal(month) {
        document.getElementById('monthModal').classList.add('active');
        document.getElementById('modalTitle').textContent = `Registro de Evidencias Mensuales - ${month} 

    // ===== Evidencias por Mes (Modal -> Apps Script) =====
    const APPS_SCRIPT_EVIDENCIAS_URL = "https://script.google.com/macros/s/AKfycbwuLKeSJL5-YSrvppBpaXJ4inbBaY91_iYdv7xFeCoLL0-HsFWFbhJikjFglNhDFeNqsg/exec";
    let SELECTED_EVIDENCE_MONTH = null;

    // Guardar el mes seleccionado cuando se abre el modal
    (function patchOpenMonthModal(){
        const original = window.openMonthModal;
        window.openMonthModal = function(month){
            SELECTED_EVIDENCE_MONTH = month;
            if (typeof original === "function") original(month);
            const t = document.getElementById("modalTitle");
            if (t) t.textContent = "Registro de Evidencias Mensuales - " + String(month) + " 2025";
        };
    })();

    function fileToBase64(file){
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onerror = () => reject(new Error("No se pudo leer el archivo"));
            reader.onload = () => {
                const dataUrl = String(reader.result || "");
                const base64 = dataUrl.includes(",") ? dataUrl.split(",")[1] : "";
                resolve(base64);
            };
            reader.readAsDataURL(file);
        });
    }

    async function submitEvidencia(e){
        e.preventDefault();
        try{
            if (!SELECTED_EVIDENCE_MONTH){
                alert("Selecciona un mes primero.");
                return;
            }

            const nombre = (document.getElementById("ev_nombre")?.value || "").trim();
            const ap1    = (document.getElementById("ev_ap1")?.value || "").trim();
            const ap2    = (document.getElementById("ev_ap2")?.value || "").trim();
            const correo = (document.getElementById("ev_correo")?.value || "").trim();

            const fileInput = document.getElementById("pdfFile");
            const file = fileInput?.files?.[0];

            if (!nombre || !ap1 || !ap2 || !correo){
                alert("Completa Nombre, Apellidos y Correo.");
                return;
            }
            if (!file){
                alert("Selecciona un PDF.");
                return;
            }
            if ((file.type || "") !== "application/pdf"){
                alert("Solo se permite PDF.");
                return;
            }

            const safeMonth = String(SELECTED_EVIDENCE_MONTH).toLowerCase();
            const fileName = (String(correo).toLowerCase() + "_" + String(safeMonth) + ".pdf")
                .replace(/[^a-zA-Z0-9._-]/g, "_");
            const base64 = await fileToBase64(file);

            const payload = {
                action: "uploadEvidence",
                month: SELECTED_EVIDENCE_MONTH,
                year: 2025,
                fileName,
                mimeType: file.type || "application/pdf",
                base64,
                enlace: { nombre, ap1, ap2, correo }
            };

            const resp = await fetch(APPS_SCRIPT_EVIDENCIAS_URL, {
                method: "POST",
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify(payload)
            });

            const raw = await resp.text();
            let data;
            try { data = JSON.parse(raw); }
            catch { throw new Error("Respuesta no JSON (HTTP " + resp.status + "). " + raw.slice(0, 200)); }

            if (!resp.ok || !data || data.success !== true){
                throw new Error((data && (data.error || data.message)) ? (data.error || data.message) : "Fallo al subir evidencia");
            }

            const link = data.fileUrl || data.webViewLink || data.webContentLink || data.url || "";
            alert("âœ… Evidencia enviada y guardada en Drive." + (link ? "\n\nEnlace: " + link : ""));
            if (typeof closeModal === "function") closeModal();
            document.getElementById("evidenciaForm")?.reset();
        }catch(err){
            alert("âŒ " + (err?.message || String(err)));
        }
    }

2025`;
    }

    function closeModal() {
        document.getElementById('monthModal').classList.remove('active');
    }

        async function exportData(format) {
        if (!requireSuperAdmin('EXPORT_' + String(format).toUpperCase())) return;

        const overlay = document.getElementById('loadingOverlay');
        const loadingText = document.querySelector('.loading-text');

        // Helpers
        const getTableData = () => {
            const table = document.getElementById('registrosTable');
            if (!table) throw new Error('No se encontrÃ³ la tabla de registros');

            const headers = Array.from(table.querySelectorAll('thead th'))
                .map(th => (th.innerText || th.textContent || '').trim())
                .filter(h => h.length > 0);

            const rows = Array.from(table.querySelectorAll('tbody tr'));
            const dataRows = rows.map(tr => {
                const cells = Array.from(tr.querySelectorAll('td')).map(td => {
                    // Evitar iconos/elementos y quedarnos con el texto visible
                    const txt = (td.innerText || td.textContent || '').replace(/\s+/g, ' ').trim();
                    return txt;
                });

                const obj = {};
                headers.forEach((h, i) => { obj[h] = cells[i] ?? ''; });
                // Si hay mÃ¡s celdas que headers, las agregamos como columnas extra
                for (let i = headers.length; i < cells.length; i++) {
                    obj[`Columna_${i+1}`] = cells[i] ?? '';
                }
                return { cells, obj };
            });

            return { headers, dataRows };
        };

        const downloadBlob = (blob, filename) => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        };

        const toCsv = (headers, rowsCells) => {
            const esc = (v) => {
                const s = String(v ?? '');
                if (/[",\n\r]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
                return s;
            };
            const lines = [];
            lines.push(headers.map(esc).join(','));
            rowsCells.forEach(cells => lines.push(cells.map(esc).join(',')));
            return lines.join('\n');
        };

                const toXlsHtml = (headers, rowsCells) => {
            const escHtml = (s) => String(s ?? '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;');

            const thead = `<tr>${headers.map(h => `<th>${escHtml(h)}</th>`).join('')}</tr>`;
            const tbody = rowsCells.map(cells => `<tr>${cells.map(c => `<td>${escHtml(c)}</td>`).join('')}</tr>`).join('');
            return `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
</head>
<body>
<table border="1">
<thead>${thead}</thead>
<tbody>${tbody}</tbody>
</table>
</body>
</html>`;
        };

        try {
            if (overlay) overlay.classList.add('active');
            if (loadingText) loadingText.textContent = `ðŸ“¥ Exportando a ${String(format).toUpperCase()}...`;

            const { headers, dataRows } = getTableData();
            const rowsCells = dataRows.map(r => r.cells);
            const today = new Date().toISOString().split('T')[0];

            if (!rowsCells.length) {
                throw new Error('No hay registros para exportar');
            }

            if (format === 'csv') {
                const csv = toCsv(headers, rowsCells);
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
                const filename = `registros_sabg_${today}.csv`;
                downloadBlob(blob, filename);
                auditLog('EXPORT_CSV', 'OK', { total: rowsCells.length });
                alert(`âœ… Datos exportados exitosamente!\n\nFormato: CSV\nArchivo: ${filename}\nTotal de registros: ${rowsCells.length}`);
            } else if (format === 'excel' || format === 'xls') {
                // ExportaciÃ³n "Excel" sin librerÃ­as: HTML .xls (Excel lo abre perfecto)
                const html = toXlsHtml(headers, rowsCells);
                const blob = new Blob([html], { type: 'application/vnd.ms-excel;charset=utf-8' });
                const filename = `registros_sabg_${today}.xls`;
                downloadBlob(blob, filename);
                auditLog('EXPORT_EXCEL', 'OK', { total: rowsCells.length });
                alert(`âœ… Datos exportados exitosamente!\n\nFormato: EXCEL\nArchivo: ${filename}\nTotal de registros: ${rowsCells.length}`);
            } else if (format === 'json') {
                const json = JSON.stringify(dataRows.map(r => r.obj), null, 2);
                const blob = new Blob([json], { type: 'application/json;charset=utf-8' });
                const filename = `registros_sabg_${today}.json`;
                downloadBlob(blob, filename);
                auditLog('EXPORT_JSON', 'OK', { total: rowsCells.length });
                alert(`âœ… Datos exportados exitosamente!\n\nFormato: JSON\nArchivo: ${filename}\nTotal de registros: ${rowsCells.length}`);
            } else {
                throw new Error('Formato de exportaciÃ³n no soportado');
            }

        } catch (error) {
            console.error(error);
            auditLog('EXPORT_' + String(format).toUpperCase(), 'ERROR', { message: String(error?.message || error) });
            alert('âŒ Error al exportar datos: ' + (error?.message || error));
        } finally {
            if (overlay) overlay.classList.remove('active');
            if (loadingText) loadingText.textContent = 'ðŸš€ Iniciando sesiÃ³n...';
        }
    }

    // ========================================
    // BÃšSQUEDA EN TABLA
    // ========================================
    const searchTableTrimestral = document.getElementById('searchTableTrimestral');
    if (searchTableTrimestral) {
        searchTableTrimestral.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#registrosTable tbody tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });
    }

    // ========================================
    // AUTOCOMPLETADO RAMO-UR Y DEPENDENCIA
    // ========================================
    const ramosUR = ['2-0','4-0','4-A00','4-E2D','4-EZQ','4-F00','4-G00','4-K00','4-N00','4-P00','4-Q00','4-T00','4-X00','5-0','5-I00','5-J00','5-K00','6-0','6-A00','6-B00','6-C00','6-D00','6-E00','6-G0N','6-G1C','6-G1H','6-G2T','6-G3A','6-GSA','6-H00','6-HAT','6-HBW','6-HHN','6-HIU','6-HJO','6-HJY','6-HKA','6-HKI','6-KCZ','7-0','7-H0C','7-H0M','7-HXA','7-HZI','8-0','8-A1I','8-AFU','8-B00','8-C00','8-D00','8-G00','8-I00','8-I6L','8-I9H','8-IZC','8-IZI','8-JAG','8-JBK','8-JBP','8-RJL','8-VSS','8-VST','9-0','9-A00','9-C00','9-D00','9-E00','9-J0U','9-J4Q','9-J9E','9-JZL','9-JZN','9-KDI','10-0','10-K2H','10-K2N','10-K2O','10-K8V','10-LAT','10-LAU','11-0','11-A00','11-B00','11-B01','11-G00','11-K00','11-L00','11-L3P','11-L4J','11-L5N','11-L5X','11-L6H','11-L6I','11-L6J','11-L6W','11-L8G','11-L8K','11-L9T','11-M00','11-MAR','11-MAX','11-MDA','11-MDE','11-MEY','11-MGC','11-MGJ','11-O00','12-0','12-E00','12-I00','12-K00','12-L00','12-M00','12-M7F','12-M7K','12-NAW','12-NBB','12-NBD','12-NBG','12-NBV','12-NCA','12-NCD','12-NCE','12-NCG','12-NCH','12-NCK','12-NCZ','12-NDE','12-NDF','12-NDY','12-NEF','12-NHK','12-O00','12-Q00','12-R00','12-S00','12-T00','12-V00','12-Y00','13-0','13-AYH','13-J2I','13-J2K','13-J2P','13-J2R','13-J2T','13-J2U','13-J2V','13-J2W','13-J2X','13-J2Y','13-J2Z','13-J3A','13-J3B','13-J3C','13-J3D','13-J3E','13-J3F','13-J3G','13-J3L','13-J4V','13-KDN','13-N9W','14-0','14-A00','14-P7R','14-PBE','14-PBJ','14-VUY','15-0','15-B00','15-QCW','15-QDV','15-QEU','15-QEZ','16-0','16-B00','16-E00','16-F00','16-G00','16-RHQ','16-RJE','16-RJJ','18-0','18-A00','18-E00','18-T0K','18-T0O','18-T0Q','18-T0U','18-T4I','18-T4L','18-T4M','18-T4N','18-T4O','18-TOM','18-TON','18-TQA','19-HC6','20-0','20-L00','20-V3A','20-VRW','21-0','21-W3N','21-W3S','25-C00','27-0','27-T00','31-0','32-0','36-0','36-B00','36-C00','36-D00','36-E00','36-F00','36-G00','36-H00','37-0','38-90A','38-90C','38-90E','38-90G','38-90I','38-90K','38-90M','38-90O','38-90Q','38-90S','38-90U','38-90W','38-90X','38-90Y','38-91A','38-91C','38-91E','38-91I','38-91K','38-91M','38-91Q','38-91S','38-91U','38-91W','38-92M','38-9ZU','38-9ZW','38-9ZY','47-AYB','47-AYI','47-AYJ','47-AYL','47-AYM','47-AYN','47-AYO','47-EZN','47-MDL','48-0','48-D00','48-E00','48-F00','48-I00','48-J00','48-L3N','48-L6U','48-L8P','48-L9Y','48-MDB','48-MDC','48-MHL','48-VZG','50-GYR','50-ZZZ','51-GYN','52-T9G','52-T9K','52-T9M','52-T9N','53-TVV','53-UHI','53-UHN','53-UHS','53-UHX','53-UIC','53-UIH','53-UIM','53-UIR','53-UIT','53-UIW','54-0','55-0'];

    const dependencias = ["ADMINISTRACIÃ“N DEL PATRIMONIO DE LA BENEFICENCIA PÃšBLICA","ADMINISTRACIÃ“N DEL SISTEMA PORTUARIO LÃZARO CÃRDENAS, S.A. DE C.V.","ADMINISTRACIÃ“N DEL SISTEMA PORTUARIO NACIONAL ALTAMIRA, S.A. DE C.V.","ADMINISTRACIÃ“N DEL SISTEMA PORTUARIO NACIONAL CABO SAN LUCAS, S.A. DE C.V.","ADMINISTRACIÃ“N DEL SISTEMA PORTUARIO NACIONAL COATZACOALCOS, S.A. DE C.V.","ADMINISTRACIÃ“N DEL SISTEMA PORTUARIO NACIONAL DOS BOCAS, S.A. DE C.V.","ADMINISTRACIÃ“N DEL SISTEMA PORTUARIO NACIONAL ENSENADA, S.A. DE C.V.","ADMINISTRACIÃ“N DEL SISTEMA PORTUARIO NACIONAL GUAYMAS, S.A. DE C.V.","ADMINISTRACIÃ“N DEL SISTEMA PORTUARIO NACIONAL MANZANILLO, S.A. DE C.V.","ADMINISTRACIÃ“N DEL SISTEMA PORTUARIO NACIONAL MAZATLÃN, S.A. DE C.V.","ADMINISTRACIÃ“N DEL SISTEMA PORTUARIO NACIONAL PROGRESO, S.A. DE C.V.","ADMINISTRACIÃ“N DEL SISTEMA PORTUARIO NACIONAL PUERTO CHIAPAS, S.A. DE C.V.","ADMINISTRACIÃ“N DEL SISTEMA PORTUARIO NACIONAL PUERTO VALLARTA, S.A. DE C.V.","ADMINISTRACIÃ“N DEL SISTEMA PORTUARIO NACIONAL SALINA CRUZ, S.A. DE C.V.","ADMINISTRACIÃ“N DEL SISTEMA PORTUARIO NACIONAL TAMPICO, S.A. DE C.V.","ADMINISTRACIÃ“N DEL SISTEMA PORTUARIO NACIONAL TOPOLOBAMPO, S.A. DE C.V.","ADMINISTRACIÃ“N DEL SISTEMA PORTUARIO NACIONAL TUXPAN, S.A. DE C.V.","ADMINISTRACIÃ“N DEL SISTEMA PORTUARIO NACIONAL VERACRUZ, S.A. DE C.V.","AEROPUERTO INTERNACIONAL DE LA CIUDAD DE MÃ‰XICO, S.A. DE C.V.","AEROPUERTO INTERNACIONAL FELIPE ÃNGELES, S.A. DE C.V.","AEROPUERTOS Y SERVICIOS AUXILIARES","AGENCIA DE TRANSFORMACIÃ“N DIGITAL Y TELECOMUNICACIONES","AGENCIA ESPACIAL MEXICANA","AGENCIA FEDERAL DE AVIACIÃ“N CIVIL","AGENCIA NACIONAL DE ADUANAS DE MÃ‰XICO","AGENCIA NACIONAL DE SEGURIDAD INDUSTRIAL Y DE PROTECCIÃ“N AL MEDIO AMBIENTE DEL SECTOR HIDROCARBUROS","AGROASEMEX, S.A.","ARCHIVO GENERAL DE LA NACIÃ“N","AUTORIDAD EDUCATIVA FEDERAL EN LA CIUDAD DE MÃ‰XICO","BANCO DEL BIENESTAR, S.N.C., I.B.D.","BANCO NACIONAL DE COMERCIO EXTERIOR, S.N.C.","BANCO NACIONAL DE OBRAS Y SERVICIOS PÃšBLICOS, S.N.C.","BANCO NACIONAL DEL EJÃ‰RCITO, FUERZA AÃ‰REA Y ARMADA, S.N.C.","CAMINOS Y PUENTES FEDERALES DE INGRESOS Y SERVICIOS CONEXOS","CASA DE MONEDA DE MÃ‰XICO","CENTRO DE CAPACITACIÃ“N CINEMATOGRÃFICA, A.C.","CENTRO DE ENSEÃ‘ANZA TÃ‰CNICA INDUSTRIAL","CENTRO DE INGENIERÃA Y DESARROLLO INDUSTRIAL","CENTRO DE INVESTIGACIÃ“N CIENTÃFICA DE YUCATÃN, A.C.","CENTRO DE INVESTIGACIÃ“N CIENTÃFICA Y DE EDUCACIÃ“N SUPERIOR DE ENSENADA, BAJA CALIFORNIA","CENTRO DE INVESTIGACIÃ“N EN ALIMENTACIÃ“N Y DESARROLLO, A.C.","CENTRO DE INVESTIGACIÃ“N EN CIENCIAS DE INFORMACIÃ“N GEOESPACIAL, A.C.","CENTRO DE INVESTIGACIÃ“N EN MATEMÃTICAS, A.C.","CENTRO DE INVESTIGACIÃ“N EN MATERIALES AVANZADOS, S.C.","CENTRO DE INVESTIGACIÃ“N EN QUÃMICA APLICADA","CENTRO DE INVESTIGACIÃ“N Y ASISTENCIA EN TECNOLOGÃA Y DISEÃ‘O DE JALISCO, A.C.","CENTRO DE INVESTIGACIÃ“N Y DE ESTUDIOS AVANZADOS DEL IPN","CENTRO DE INVESTIGACIÃ“N Y DESARROLLO TECNOLÃ“GICO EN ELECTROQUÃMICA, S.C.","CENTRO DE INVESTIGACIÃ“N Y DOCENCIA ECONÃ“MICAS, A.C.","CENTRO DE INVESTIGACIONES BIOLÃ“GICAS DEL NOROESTE, S.C.","CENTRO DE INVESTIGACIONES EN Ã“PTICA, A.C.","CENTRO DE INVESTIGACIONES Y ESTUDIOS SUPERIORES EN ANTROPOLOGÃA SOCIAL","CENTRO DE PRODUCCIÃ“N DE PROGRAMAS INFORMATIVOS Y ESPECIALES","CENTRO FEDERAL DE CONCILIACIÃ“N Y REGISTRO LABORAL","CENTRO NACIONAL DE CONTROL DE ENERGÃA","CENTRO NACIONAL DE CONTROL DEL GAS NATURAL","CENTRO NACIONAL DE EQUIDAD DE GÃ‰NERO Y SALUD REPRODUCTIVA","CENTRO NACIONAL DE EXCELENCIA TECNOLÃ“GICA EN SALUD","CENTRO NACIONAL DE LA TRANSFUSIÃ“N SANGUÃNEA","CENTRO NACIONAL DE METROLOGÃA","CENTRO NACIONAL DE PREVENCIÃ“N DE DESASTRES","CENTRO NACIONAL DE PROGRAMAS PREVENTIVOS Y CONTROL DE ENFERMEDADES","CENTRO NACIONAL DE TRASPLANTES","CENTRO NACIONAL PARA LA PREVENCIÃ“N Y CONTROL DEL VIH/SIDA","CENTRO NACIONAL PARA LA SALUD DE LA INFANCIA Y LA ADOLESCENCIA","CENTROS DE INTEGRACIÃ“N JUVENIL, A.C.","CIATEC, A.C.","CIATEQ, A.C.","COLEGIO DE BACHILLERES","COLEGIO DE POSTGRADUADOS","COLEGIO NACIONAL DE EDUCACIÃ“N PROFESIONAL TÃ‰CNICA","COLEGIO SUPERIOR AGROPECUARIO DEL ESTADO DE GUERRERO","COMISIÃ“N DE APELACIÃ“N Y ARBITRAJE DEL DEPORTE","COMISIÃ“N DE OPERACIÃ“N Y FOMENTO DE ACTIVIDADES ACADÃ‰MICAS DEL IPN","COMISIÃ“N EJECUTIVA DE ATENCIÃ“N A VÃCTIMAS","COMISIÃ“N FEDERAL PARA LA PROTECCIÃ“N CONTRA RIESGOS SANITARIOS","COMISIÃ“N NACIONAL BANCARIA Y DE VALORES","COMISIÃ“N NACIONAL DE ACUACULTURA Y PESCA","COMISIÃ“N NACIONAL DE ARBITRAJE MÃ‰DICO","COMISIÃ“N NACIONAL DE ÃREAS NATURALES PROTEGIDAS","COMISIÃ“N NACIONAL DE BIOÃ‰TICA","COMISIÃ“N NACIONAL DE BÃšSQUEDA DE PERSONAS","COMISIÃ“N NACIONAL DE CULTURA FÃSICA Y DEPORTE","COMISIÃ“N NACIONAL DE HIDROCARBUROS","COMISIÃ“N NACIONAL DE LAS ZONAS ÃRIDAS","COMISIÃ“N NACIONAL DE LIBROS DE TEXTO GRATUITOS","COMISIÃ“N NACIONAL DE LOS SALARIOS MÃNIMOS","COMISIÃ“N NACIONAL DE MEJORA REGULATORIA","COMISIÃ“N NACIONAL DE SALUD MENTAL Y ADICCIONES","COMISIÃ“N NACIONAL DE SEGURIDAD NUCLEAR Y SALVAGUARDIAS","COMISIÃ“N NACIONAL DE SEGUROS Y FIANZAS","COMISIÃ“N NACIONAL DE VIVIENDA","COMISIÃ“N NACIONAL DEL AGUA","COMISIÃ“N NACIONAL DEL SISTEMA DE AHORRO PARA EL RETIRO","COMISIÃ“N NACIONAL FORESTAL","COMISIÃ“N NACIONAL PARA EL USO EFICIENTE DE LA ENERGÃA","COMISIÃ“N NACIONAL PARA LA MEJORA CONTINUA DE LA EDUCACIÃ“N","COMISIÃ“N NACIONAL PARA LA PROTECCIÃ“N Y DEFENSA DE LOS USUARIOS DE SERVICIOS FINANCIEROS","COMISIÃ“N REGULADORA DE ENERGÃA","COMITÃ‰ NACIONAL PARA EL DESARROLLO SUSTENTABLE DE LA CAÃ‘A DE AZÃšCAR","COMPAÃ‘ÃA MEXICANA DE EXPLORACIONES, S.A. DE C.V.","COMPAÃ‘ÃA OPERADORA DEL CENTRO CULTURAL Y TURÃSTICO DE TIJUANA, S.A. DE C.V.","CONSEJERÃA JURÃDICA DEL EJECUTIVO FEDERAL","CONSEJO NACIONAL DE EVALUACIÃ“N DE LA POLÃTICA DE DESARROLLO SOCIAL","CONSEJO NACIONAL DE FOMENTO EDUCATIVO","CONSEJO NACIONAL DE HUMANIDADES, CIENCIAS Y TECNOLOGÃAS","CONSEJO NACIONAL PARA EL DESARROLLO Y LA INCLUSIÃ“N DE LAS PERSONAS CON DISCAPACIDAD","CONSEJO NACIONAL PARA PREVENIR LA DISCRIMINACIÃ“N","CONSOLIDADO","COORDINACIÃ“N GENERAL DE LA COMISIÃ“N MEXICANA DE AYUDA A REFUGIADOS","COORDINACIÃ“N NACIONAL ANTISECUESTRO Y DELITOS DE ALTO IMPACTO","COORDINACIÃ“N NACIONAL DE BECAS PARA EL BIENESTAR BENITO JUÃREZ","COORDINACIÃ“N PARA LA ATENCIÃ“N INTEGRAL DE LA MIGRACIÃ“N EN LA FRONTERA SUR","CORREDOR INTEROCEÃNICO DEL ISTMO DE TEHUANTEPEC","EDUCAL, S.A. DE C.V.","EL COLEGIO DE LA FRONTERA NORTE, A.C.","EL COLEGIO DE LA FRONTERA SUR","EL COLEGIO DE MÃ‰XICO, A.C.","EL COLEGIO DE MICHOACÃN, A.C.","EL COLEGIO DE SAN LUIS, A.C.","ESTUDIOS CHURUBUSCO AZTECA, S.A.","EXPORTADORA DE SAL, S.A. DE C.V.","FERROCARRIL DEL ISTMO DE TEHUANTEPEC, S.A. DE C.V.","FIDEICOMISO DE FOMENTO MINERO","FIDEICOMISO DE LOS SISTEMAS NORMALIZADO DE COMPETENCIA LABORAL Y DE CERTIFICACIÃ“N","FIDEICOMISO DE RIESGO COMPARTIDO","FIDEICOMISO FONDO NACIONAL DE FOMENTO EJIDAL","FIDEICOMISO PARA LA CINETECA NACIONAL","FIDEICOMISO UNIVERSIDAD MARÃTIMA Y PORTUARIA DE MÃ‰XICO","FINANCIERA PARA EL BIENESTAR","FONATUR INFRAESTRUCTURA, S.A. DE C.V.","FONDO DE CAPITALIZACIÃ“N E INVERSIÃ“N DEL SECTOR RURAL","FONDO DE CULTURA ECONÃ“MICA","FONDO DE GARANTÃA Y FOMENTO PARA LA AGRICULTURA, GANADERÃA Y AVICULTURA","FONDO DE LA VIVIENDA DEL ISSSTE","FONDO NACIONAL DE FOMENTO AL TURISMO","FONDO NACIONAL PARA EL FOMENTO DE LAS ARTESANÃAS","GUARDIA NACIONAL","HOSPITAL GENERAL DR. MANUEL GEA GONZÃLEZ","HOSPITAL GENERAL DE MÃ‰XICO DR. EDUARDO LICEAGA","HOSPITAL INFANTIL DE MÃ‰XICO FEDERICO GÃ“MEZ","HOSPITAL JUÃREZ DE MÃ‰XICO","IMPRESORA Y ENCUADERNADORA PROGRESO, S.A. DE C.V.","INFOTEC CENTRO DE INVESTIGACIÃ“N E INNOVACIÃ“N EN TIC","INNOVABIENESTAR DE MÃ‰XICO, S.A.P.I. DE C.V.","INSTITUTO DE ADMINISTRACIÃ“N Y AVALÃšOS DE BIENES NACIONALES","INSTITUTO DE ECOLOGÃA, A.C.","INSTITUTO DE INVESTIGACIONES DR. JOSÃ‰ MARÃA LUIS MORA","INSTITUTO DE SEGURIDAD SOCIAL PARA LAS FUERZAS ARMADAS MEXICANAS","INSTITUTO DE SEGURIDAD Y SERVICIOS SOCIALES DE LOS TRABAJADORES DEL ESTADO","INSTITUTO DEL FONDO NACIONAL PARA EL CONSUMO DE LOS TRABAJADORES","INSTITUTO MEXICANO DE CINEMATOGRAFÃA","INSTITUTO MEXICANO DE INVESTIGACIÃ“N EN PESCA Y ACUACULTURA SUSTENTABLES","INSTITUTO MEXICANO DE LA PROPIEDAD INDUSTRIAL","INSTITUTO MEXICANO DE LA RADIO","INSTITUTO MEXICANO DE TECNOLOGÃA DEL AGUA","INSTITUTO MEXICANO DEL PETRÃ“LEO","INSTITUTO MEXICANO DEL SEGURO SOCIAL","INSTITUTO MEXICANO DEL TRANSPORTE","INSTITUTO NACIONAL DE ANTROPOLOGÃA E HISTORIA","INSTITUTO NACIONAL DE ASTROFÃSICA, Ã“PTICA Y ELECTRÃ“NICA","INSTITUTO NACIONAL DE BELLAS ARTES Y LITERATURA","INSTITUTO NACIONAL DE CANCEROLOGÃA","INSTITUTO NACIONAL DE CARDIOLOGÃA IGNACIO CHÃVEZ","INSTITUTO NACIONAL DE CIENCIAS MÃ‰DICAS Y NUTRICIÃ“N SALVADOR ZUBIRÃN","INSTITUTO NACIONAL DE ECOLOGÃA Y CAMBIO CLIMÃTICO","INSTITUTO NACIONAL DE ELECTRICIDAD Y ENERGÃAS LIMPIAS","INSTITUTO NACIONAL DE ENFERMEDADES RESPIRATORIAS ISMAEL COSÃO VILLEGAS","INSTITUTO NACIONAL DE GERIATRÃA","INSTITUTO NACIONAL DE INVESTIGACIONES FORESTALES, AGRÃCOLAS Y PECUARIAS","INSTITUTO NACIONAL DE INVESTIGACIONES NUCLEARES","INSTITUTO NACIONAL DE LA ECONOMÃA SOCIAL","INSTITUTO NACIONAL DE LA INFRAESTRUCTURA FÃSICA EDUCATIVA","INSTITUTO NACIONAL DE LAS MUJERES","INSTITUTO NACIONAL DE LAS PERSONAS ADULTAS MAYORES","INSTITUTO NACIONAL DE LENGUAS INDÃGENAS","INSTITUTO NACIONAL DE LOS PUEBLOS INDÃGENAS","INSTITUTO NACIONAL DE MEDICINA GENÃ“MICA","INSTITUTO NACIONAL DE MIGRACIÃ“N","INSTITUTO NACIONAL DE NEUROLOGÃA Y NEUROCIRUGÃA MANUEL VELASCO SUÃREZ","INSTITUTO NACIONAL DE PEDIATRÃA","INSTITUTO NACIONAL DE PERINATOLOGÃA ISIDRO ESPINOSA DE LOS REYES","INSTITUTO NACIONAL DE PSIQUIATRÃA RAMÃ“N DE LA FUENTE MUÃ‘IZ","INSTITUTO NACIONAL DE REHABILITACIÃ“N LUIS GUILLERMO IBARRA IBARRA","INSTITUTO NACIONAL DE SALUD PÃšBLICA","INSTITUTO NACIONAL DEL SUELO SUSTENTABLE","INSTITUTO NACIONAL PARA EL DESARROLLO DE CAPACIDADES DEL SECTOR RURAL, A.C.","INSTITUTO NACIONAL PARA EL FEDERALISMO Y EL DESARROLLO MUNICIPAL","INSTITUTO NACIONAL PARA LA EDUCACIÃ“N DE LOS ADULTOS","INSTITUTO PARA DEVOLVER AL PUEBLO LO ROBADO","INSTITUTO PARA LA PROTECCIÃ“N AL AHORRO BANCARIO","INSTITUTO POLITÃ‰CNICO NACIONAL","INSTITUTO POTOSINO DE INVESTIGACIÃ“N CIENTÃFICA Y TECNOLÃ“GICA, A.C.","LABORATORIOS DE BIOLÃ“GICOS Y REACTIVOS DE MÃ‰XICO, S.A. DE C.V.","LITIO PARA MÃ‰XICO","LOTERÃA NACIONAL","NACIONAL FINANCIERA, S.N.C.","OFICINA DE LA PRESIDENCIA DE LA REPÃšBLICA","ORGANISMO COORDINADOR DE UNIVERSIDADES PARA EL BIENESTAR BENITO JUÃREZ","ORGANISMO PROMOTOR DE INVERSIONES EN TELECOMUNICACIONES","PATRONATO DE OBRAS E INSTALACIONES DEL IPN","PEMEX CORPORATIVO","PREVENCIÃ“N Y REINSERCIÃ“N SOCIAL","PROCURADURÃA AGRARIA","PROCURADURÃA DE LA DEFENSA DEL CONTRIBUYENTE","PROCURADURÃA FEDERAL DE LA DEFENSA DEL TRABAJO","PROCURADURÃA FEDERAL DE PROTECCIÃ“N AL AMBIENTE","PROCURADURÃA FEDERAL DEL CONSUMIDOR","PRODUCTORA NACIONAL DE BIOLÃ“GICOS VETERINARIOS","RADIO EDUCACIÃ“N","REGISTRO AGRARIO NACIONAL","SECRETARÃA ANTICORRUPCIÃ“N Y BUEN GOBIERNO","SECRETARÃA DE AGRICULTURA Y DESARROLLO RURAL","SECRETARÃA DE BIENESTAR","SECRETARÃA DE CULTURA","SECRETARÃA DE DESARROLLO AGRARIO, TERRITORIAL Y URBANO","SECRETARÃA DE ECONOMÃA","SECRETARÃA DE EDUCACIÃ“N PÃšBLICA","SECRETARÃA DE ENERGÃA","SECRETARÃA DE GOBERNACIÃ“N","SECRETARÃA DE HACIENDA Y CRÃ‰DITO PÃšBLICO","SECRETARÃA DE INFRAESTRUCTURA, COMUNICACIONES Y TRANSPORTES","SECRETARÃA DE LA DEFENSA NACIONAL","SECRETARÃA DE MEDIO AMBIENTE Y RECURSOS NATURALES","SECRETARÃA DE RELACIONES EXTERIORES","SECRETARÃA DE SALUD","SECRETARÃA DE SEGURIDAD Y PROTECCIÃ“N CIUDADANA","SECRETARÃA DE TURISMO","SECRETARÃA DEL TRABAJO Y PREVISIÃ“N SOCIAL","SECRETARÃA EJECUTIVA DEL SISTEMA NACIONAL ANTICORRUPCIÃ“N","SECRETARÃA GENERAL DEL CONSEJO NACIONAL DE POBLACIÃ“N","SECRETARIADO EJECUTIVO DEL SISTEMA NACIONAL DE SEGURIDAD PÃšBLICA","SEGURIDAD ALIMENTARIA MEXICANA","SERVICIO DE ADMINISTRACIÃ“N TRIBUTARIA","SERVICIO DE INFORMACIÃ“N AGROALIMENTARIA Y PESQUERA","SERVICIO DE PROTECCIÃ“N FEDERAL","SERVICIO GEOLÃ“GICO MEXICANO","SERVICIO NACIONAL DE INSPECCIÃ“N Y CERTIFICACIÃ“N DE SEMILLAS","SERVICIO NACIONAL DE SANIDAD, INOCUIDAD Y CALIDAD AGROALIMENTARIA","SERVICIO POSTAL MEXICANO","SERVICIOS A LA NAVEGACIÃ“N EN EL ESPACIO AÃ‰REO MEXICANO","SERVICIOS DE SALUD DEL IMSS-BIENESTAR","SISTEMA NACIONAL PARA EL DESARROLLO INTEGRAL DE LA FAMILIA","SISTEMA PÃšBLICO DE RADIODIFUSIÃ“N DEL ESTADO MEXICANO","SOCIEDAD HIPOTECARIA FEDERAL, S.N.C.","TALLERES GRÃFICOS DE MÃ‰XICO","TECNOLÃ“GICO NACIONAL DE MÃ‰XICO","TELEVISIÃ“N METROPOLITANA, S.A. DE C.V.","TREN MAYA, S.A. DE C.V.","TRIBUNAL FEDERAL DE CONCILIACIÃ“N Y ARBITRAJE","TRIBUNAL FEDERAL DE JUSTICIA FISCAL Y ADMINISTRATIVA","TRIBUNAL SUPERIOR AGRARIO","TURÃSTICA INTEGRAL ISLAS MARÃAS, S.A. DE C.V.","UNIDAD DEL SISTEMA PARA LA CARRERA DE LAS MAESTRAS Y LOS MAESTROS","UNIVERSIDAD ABIERTA Y A DISTANCIA DE MÃ‰XICO","UNIVERSIDAD AUTÃ“NOMA CHAPINGO","UNIVERSIDAD PEDAGÃ“GICA NACIONAL","XE-IPN CANAL 11"];

    function initAutocomplete() {
        const ramoInput = document.getElementById('ramoUrInput');
        const ramoSuggestions = document.getElementById('ramoUrSuggestions');
        const depInput = document.getElementById('dependenciaInput');
        const depSuggestions = document.getElementById('dependenciaSuggestions');

        if (ramoInput && ramoSuggestions) {
            setupAutocomplete(ramoInput, ramoSuggestions, ramosUR);
        }

        if (depInput && depSuggestions) {
            setupAutocomplete(depInput, depSuggestions, dependencias);
        }
    }

    function setupAutocomplete(input, suggestionsContainer, dataList) {
        let currentFocus = -1;

        input.addEventListener('input', function() {
            const value = this.value.toLowerCase();
            currentFocus = -1;
            suggestionsContainer.innerHTML = '';

            if (!value) {
                suggestionsContainer.classList.remove('show');
                return;
            }

            const filtered = dataList.filter(item => 
                item.toLowerCase().includes(value)
            );

            if (filtered.length === 0) {
                suggestionsContainer.innerHTML = '<div class="no-suggestions">No se encontraron coincidencias</div>';
                suggestionsContainer.classList.add('show');
                return;
            }

            filtered.forEach(item => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                
                const pos = item.toLowerCase().indexOf(value);
                const beforeMatch = item.substring(0, pos);
                const matchText = item.substring(pos, pos + value.length);
                const afterMatch = item.substring(pos + value.length);
                
                div.innerHTML = beforeMatch + '<span class="suggestion-highlight">' + matchText + '</span>' + afterMatch;
                
                div.addEventListener('click', function() {
                    input.value = item;
                    suggestionsContainer.classList.remove('show');
                });
                
                suggestionsContainer.appendChild(div);
            });

            suggestionsContainer.classList.add('show');
        });

        document.addEventListener('click', function(e) {
            if (e.target !== input && e.target !== suggestionsContainer) {
                suggestionsContainer.classList.remove('show');
            }
        });
    }

    // ========================================
    // INICIALIZACIÃ“N
    // ========================================
    window.addEventListener('load', () => {
        createParticles();
        initAutocomplete();
    });

    // Cerrar modal al hacer clic fuera
    window.addEventListener('click', (e) => {
        const modal = document.getElementById('monthModal');
        if (e.target === modal) {
            closeModal();
        }
    });


    async function cargarRegistrosTrimestral() {
    try {
        const url = userRole === 'superadmin' 
            ? '/api/trimestral/list'
            : `/api/trimestral/list?dependencia=${encodeURIComponent(userDependencia)}`;

        const response = await fetch(url);
        const result = await response.json();

        if (result.success) {
            const tbody = document.querySelector('#registrosTable tbody');
            tbody.innerHTML = '';

            result.data.forEach((registro, index) => {
                const row = tbody.insertRow();
                
                // Determinar si el estado de avance estÃ¡ desactualizado
                const estadosRojos = ['CAMBIÃ“ LA INSTITUCIÃ“N ACADÃ‰MICA DE INTERÃ‰S', 'PERSONA QUE DESERTÃ“'];
                const claseEstadoRojo = estadosRojos.includes(registro.estado_avance) ? 'estado-rojo' : '';
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${registro.trimestre || ''}</td>
                    <td>${registro.id_rusp || ''}</td>
                    <td>${registro.primer_apellido || ''}</td>
                    <td>${registro.segundo_apellido || ''}</td>
                    <td>${registro.nombre || ''}</td>
                    <td>${registro.curp || ''}</td>
                    <td>${registro.nivel_puesto || ''}</td>
                    <td>${registro.nivel_tabular || ''}</td>
                    <td>${registro.ramo_ur || ''}</td>
                    <td>${registro.dependencia || ''}</td>
                    <td>${registro.correo_institucional || ''}</td>
                    <td>${registro.telefono_institucional || ''}</td>
                    <td class="editable-cell" data-field="nivel_educativo" onclick="makeEditable(this)" role="button" tabindex="0">
                        ${registro.nivel_educativo || ''}
                        <span class="edit-icon">âœï¸</span>
                    </td>
                    <td class="editable-cell" data-field="institucion_educativa" onclick="makeEditable(this)" role="button" tabindex="0">
                        ${registro.institucion_educativa || ''}
                        <span class="edit-icon">âœï¸</span>
                    </td>
                    <td class="editable-cell" data-field="modalidad" onclick="makeEditable(this)" role="button" tabindex="0">
                        ${registro.modalidad || ''}
                        <span class="edit-icon">âœï¸</span>
                    </td>
                    <td class="editable-cell ${claseEstadoRojo}" data-field="estado_avance" onclick="makeEditable(this)" role="button" tabindex="0">
                        ${registro.estado_avance || ''}
                        <span class="edit-icon">âœï¸</span>
                    </td>
                    <td class="editable-cell" data-field="observaciones" onclick="makeEditable(this)" role="button" tabindex="0">
                        ${registro.observaciones || '-'}
                        <span class="edit-icon">âœï¸</span>
                    </td>
                    <td>${registro.enlace_nombre || ''}</td>
                    <td>${registro.enlace_primer_apellido || ''}</td>
                    <td>${registro.enlace_segundo_apellido || ''}</td>
                    <td>${registro.enlace_correo || ''}</td>
                    <td>${registro.enlace_telefono || ''}</td>
                `;
            });
            updateStatsFromRegistros(result.data);

        }
    } catch (error) {
    }
}
async function guardarRegistroTrimestral() {
    const form = document.getElementById('trimestralForm');
    const formData = new FormData(form);
    
    const data = {
        enlace_nombre: formData.get('enlace_nombre'),
        enlace_primer_apellido: formData.get('enlace_apellido1'),
        enlace_segundo_apellido: formData.get('enlace_apellido2'),
        enlace_correo: formData.get('enlace_correo'),
        enlace_telefono: formData.get('enlace_telefono'),
        trimestre: formData.get('trimestre'),
        id_rusp: formData.get('id_rusp'),
        primer_apellido: formData.get('primer_apellido'),
        segundo_apellido: formData.get('segundo_apellido'),
        nombre: formData.get('nombre'),
        curp: formData.get('curp'),
        nivel_puesto: formData.get('nivel_puesto'),
        nivel_tabular: formData.get('nivel_tabular'),
        ramo_ur: formData.get('ramo_ur'),
        dependencia: formData.get('dependencia'),
        correo_institucional: formData.get('correo_institucional'),
        telefono_institucional: formData.get('telefono_institucional'),
        nivel_educativo: formData.get('nivel_educativo'),
        institucion_educativa: formData.get('institucion_educativa'),
        modalidad: formData.get('modalidad'),
        estado_avance: formData.get('estado_avance'),
        observaciones: formData.get('observaciones'),
        usuario_registro: userName
    };

    try {
        const response = await fetch('/api/trimestral/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
            alert('âœ… Registro guardado exitosamente!');
            form.reset();
            await cargarRegistrosTrimestral();
        } else {
            alert('âŒ Error: ' + result.error);
        }
    } catch (error) {
        alert('âŒ Error de conexiÃ³n con el servidor');
    }
}
            // ========================================
// BACKUP DE BASE DE DATOS
// ========================================
async function descargarBackup() {
    if (!requireSuperAdmin('DOWNLOAD_BACKUP')) return;

    auditLog('DOWNLOAD_BACKUP', 'START', {});

    if (!confirm('Â¿Deseas descargar el backup completo de la base de datos?\n\nEsto incluye:\nâ€¢ Todos los registros trimestrales\nâ€¢ InformaciÃ³n de usuarios (sin contraseÃ±as)\nâ€¢ Fecha y hora del backup')) {
        return;
    }

    try {
        document.getElementById('loadingOverlay').classList.add('active');
        document.querySelector('.loading-text').textContent = 'ðŸ’¾ Generando backup...';

        const response = await fetch('/api/backup/export');
        
        if (!response.ok) {
            throw new Error('Error al generar backup');
        }

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `backup_sabg_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

        
        auditLog('DOWNLOAD_BACKUP', 'OK', {});
document.getElementById('loadingOverlay').classList.remove('active');
        document.querySelector('.loading-text').textContent = 'ðŸš€ Iniciando sesiÃ³n...';

        auditLog('EXPORT_' + String(format).toUpperCase(), 'OK', { format });

        alert('âœ… Backup descargado exitosamente!\n\nArchivo: backup_sabg_' + new Date().toISOString().split('T')[0] + '.json\n\nGuarda este archivo en un lugar seguro.');

    } catch (error) {
        auditLog('DOWNLOAD_BACKUP', 'ERROR', { message: String(error && error.message ? error.message : error) });
        document.getElementById('loadingOverlay').classList.remove('active');
        alert('âŒ Error al generar backup: ' + error.message);
    }
}
    
    function populateRegDependencias() {
        const dl = document.getElementById('dep_reg_list');
        if (!dl || typeof dependencias === 'undefined' || !Array.isArray(dependencias)) return [];
        dl.innerHTML = '';
        // Unique + sorted
        const uniq = Array.from(new Set(dependencias.map(d => String(d).trim()).filter(Boolean)))
            .sort((a, b) => a.localeCompare(b, 'es'));
        const frag = document.createDocumentFragment();
        uniq.forEach((d) => {
            const opt = document.createElement('option');
            opt.value = d;
            frag.appendChild(opt);
        });
        dl.appendChild(frag);
        return uniq;
    }


function initDependenciaAutocomplete() {
        const input = document.getElementById('reg_dependencia');
        const menu = document.getElementById('dep_reg_menu');
        if (!input || !menu) return;

        const data = populateRegDependencias();
        let currentIndex = -1;

        const setExpanded = (v) => {
            input.setAttribute('aria-expanded', v ? 'true' : 'false');
        };

        const closeMenu = () => {
            menu.classList.remove('open');
            menu.innerHTML = '';
            currentIndex = -1;
            setExpanded(false);
        };

        const openMenu = () => {
            menu.classList.add('open');
            setExpanded(true);
        };

        const render = (query) => {
            const q = String(query || '').toLowerCase().trim();
            const matches = data
                .filter((d) => d.toLowerCase().includes(q))
                .slice(0, 250);

            menu.innerHTML = '';
            currentIndex = -1;

            if (!matches.length) {
                closeMenu();
                return;
            }

            const frag = document.createDocumentFragment();
            matches.forEach((d, i) => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'autocomplete-item';
                btn.setAttribute('role', 'option');
                btn.setAttribute('data-index', String(i));
                btn.textContent = d;

                // mousedown para no perder focus antes de seleccionar
                btn.addEventListener('mousedown', (ev) => {
                    ev.preventDefault();
                    input.value = d;
                    closeMenu();
                });

                frag.appendChild(btn);
            });

            menu.appendChild(frag);
            openMenu();
        };

        const highlight = () => {
            const items = Array.from(menu.querySelectorAll('.autocomplete-item'));
            items.forEach((el, idx) => {
                el.classList.toggle('active', idx === currentIndex);
            });
            if (currentIndex >= 0 && items[currentIndex]) {
                items[currentIndex].scrollIntoView({ block: 'nearest' });
            }
        };

        input.addEventListener('focus', () => render(input.value));
        input.addEventListener('input', () => render(input.value));

        input.addEventListener('keydown', (e) => {
            if (!menu.classList.contains('open')) return;

            const items = Array.from(menu.querySelectorAll('.autocomplete-item'));
            if (!items.length) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                currentIndex = Math.min(currentIndex + 1, items.length - 1);
                highlight();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                currentIndex = Math.max(currentIndex - 1, 0);
                highlight();
            } else if (e.key === 'Enter') {
                if (currentIndex >= 0 && items[currentIndex]) {
                    e.preventDefault();
                    input.value = items[currentIndex].textContent || '';
                    closeMenu();
                }
            } else if (e.key === 'Escape') {
                e.preventDefault();
                closeMenu();
            }
        });

        document.addEventListener('click', (e) => {
            if (e.target === input) return;
            if (menu.contains(e.target)) return;
            closeMenu();
        });

        // Si la lista es muy grande, abre al inicio para facilitar bÃºsqueda
        // (solo si el campo estÃ¡ vacÃ­o)
        input.addEventListener('click', () => {
            if (!input.value) render('');
        });
    }

document.addEventListener('DOMContentLoaded', () => {
    // Restaurar rol si existe
    try { userRole = localStorage.getItem('SABG_ROL') || userRole; } catch(e) {}
    initDependenciaAutocomplete();
    applyRoleVisibility();

    // Carga masiva: cuando el admin seleccione archivo, cargar automÃ¡ticamente
    const excelInput = document.getElementById('excelFile');
    if (excelInput) {
        excelInput.addEventListener('change', () => {
            try {
                if (excelInput.files && excelInput.files.length) uploadExcel();
            } catch (e) {
                console.error(e);
                alert('Error al cargar el archivo. Revisa la consola.');
            }
        });
    }
});
</script>

<script>
/* =========================
   SUBIR EVIDENCIAS (PDF) -> Google Drive (Apps Script)
   =========================
   - Evita preflight CORS usando Content-Type: text/plain
   - Parse seguro (text -> JSON) para evitar: Unexpected end of JSON input
*/

const APPS_SCRIPT_EVIDENCIAS_URL = "https://script.google.com/macros/s/AKfycbwuLKeSJL5-YSrvppBpaXJ4inbBaY91_iYdv7xFeCoLL0-HsFWFbhJikjFglNhDFeNqsg/exec";

function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => {
      const result = String(reader.result || "");
      const base64 = result.includes(",") ? result.split(",")[1] : result;
      resolve(base64);
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

async function uploadPdfToDrive(file) {
  if (!file) throw new Error("No se seleccionÃ³ archivo");
  const mime = file.type || "application/pdf";
  if (mime !== "application/pdf") {
    throw new Error("Solo se permiten archivos PDF");
  }

  const base64 = await fileToBase64(file);

  const payload = {
    fileName: file.name,
    filename: file.name,          // compatibilidad por si tu Apps Script usa 'filename'
    mimeType: mime,
    base64
  };

  const resp = await fetch(APPS_SCRIPT_EVIDENCIAS_URL, {
    method: "POST",
    headers: {
      // IMPORTANTE: text/plain para evitar preflight OPTIONS y errores CORS con Apps Script
      "Content-Type": "text/plain;charset=utf-8"
    },
    body: JSON.stringify(payload)
  });

  // Parse seguro: Apps Script a veces regresa texto vacÃ­o/HTML en error
  const raw = await resp.text();
  let json;
  try {
    json = JSON.parse(raw);
  } catch (e) {
    throw new Error("Respuesta no-JSON desde Apps Script. Inicio: " + raw.slice(0, 200));
  }

  if (!resp.ok || !json.success) {
    throw new Error(json.error || `FallÃ³ la subida del PDF (HTTP ${resp.status})`);
  }

  return json; // se espera: {success:true, fileId, fileUrl} (o equivalente)
}

document.addEventListener("DOMContentLoaded", () => {
  const btnEnviar = document.getElementById("btnEnviarEvidencia");
  const inputFile = document.getElementById("archivoEvidencia");

  if (!btnEnviar || !inputFile) return;

  btnEnviar.addEventListener("click", async () => {
    try {
      if (!inputFile.files.length) {
        alert("Selecciona un archivo PDF");
        return;
      }

      btnEnviar.disabled = true;
      const originalText = btnEnviar.textContent;
      btnEnviar.textContent = "Subiendo PDF...";

      const result = await uploadPdfToDrive(inputFile.files[0]);

      const link = result.fileUrl || result.webViewLink || result.webContentLink || result.url || "";
      console.log("PDF en Drive:", link || result);

      alert("âœ… Evidencia cargada correctamente" + (link ? "\n\nEnlace: " + link : ""));
      inputFile.value = "";
      btnEnviar.textContent = originalText;
    } catch (err) {
      console.error(err);
      alert("âŒ Error al subir PDF: " + (err && err.message ? err.message : String(err)));
    } finally {
      btnEnviar.disabled = false;
      if (btnEnviar.textContent === "Subiendo PDF...") btnEnviar.textContent = "Enviar Evidencia";
    }
  });
});
</script>

</body>
</html>
